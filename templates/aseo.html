<!DOCTYPE html>
<html lang="es">
<head>
<link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aseo - Distribuidora Universal</title>
<link rel="stylesheet" href="/static/style.css">
<link rel="stylesheet" href="/static/aseo.css">
</head>
<body class="pagina-aseo">

<header class="header aseo-header-wrap">
  <div class="fila-superior aseo-header">
    <div class="aseo-title">
      <span class="icono">&#127758;</span>
      <div class="nombre">Aseo</div>
    </div>
    <div class="acciones aseo-actions">
      <a href="https://wa.me/573215485315" class="whatsapp" target="_blank" rel="noopener" aria-label="WhatsApp">W</a>
      <a href="/" class="volver" aria-label="Volver">&#8592;</a>
      <a href="/tienda" class="carrito-mini" aria-label="Tienda">&#128722;</a>
      <a href="/cuenta" class="login" aria-label="Cuenta">&#128100;</a>
      <a href="#" class="modo-nocturno" aria-label="Modo nocturno">&#9789;</a>
    </div>
  </div>
</header>

<main class="aseo-main">
  {% if db_missing %}
  <div class="aseo-empty">
    <strong>Base de datos no encontrada.</strong>
    <p>No se pudo cargar el catalogo de aseo.</p>
  </div>
  {% else %}
  <nav class="aseo-main-cats" aria-label="Categorias principales">
    <a class="aseo-main-cat active" href="/aseo">
      <span class="cat-circle"><img src="/static/images/banner1.jpg" alt="Aseo" loading="lazy" decoding="async"></span>
      <span class="cat-name">Aseo</span>
    </a>
    <a class="aseo-main-cat" href="/tienda?cat=drogueria">
      <span class="cat-circle"><img src="/static/images/banner6.jpg" alt="Drogueria" loading="lazy" decoding="async"></span>
      <span class="cat-name">Drogueria</span>
    </a>
    <a class="aseo-main-cat" href="/tienda?cat=ferreteria">
      <span class="cat-circle"><img src="/static/images/banner3.jpg" alt="Ferreteria" loading="lazy" decoding="async"></span>
      <span class="cat-name">Ferreteria</span>
    </a>
    <a class="aseo-main-cat" href="/tienda?cat=papeleria">
      <span class="cat-circle"><img src="/static/images/banner8.jpg" alt="Papeleria" loading="lazy" decoding="async"></span>
      <span class="cat-name">Papeleria</span>
    </a>
    <a class="aseo-main-cat" href="/tienda?cat=comestibles">
      <span class="cat-circle"><img src="/static/images/banner2.jpg" alt="Abarrotes" loading="lazy" decoding="async"></span>
      <span class="cat-name">Abarrotes</span>
    </a>
    <a class="aseo-main-cat" href="/tienda?cat=insecticidas">
      <span class="cat-circle"><img src="/static/images/banner4.jpg" alt="Insecticidas" loading="lazy" decoding="async"></span>
      <span class="cat-name">Insecticidas</span>
    </a>
  </nav>

  <nav class="aseo-knobs" aria-label="Subcategorias de aseo">
    <a href="/tienda" class="aseo-knob aseo-knob-back">
      <span class="knob-circle" aria-hidden="true">&#8592;</span>
      <span class="knob-name">Devolver</span>
    </a>
    {% for section in sections %}
    {% set knob_img = '/static/images/banner1.jpg' %}
    {% if section['slug'] == 'lava-lozas' %}
      {% set knob_img = '/static/images/banner2.jpg' %}
    {% elif section['slug'] == 'limpidos' %}
      {% set knob_img = '/static/images/banner4.jpg' %}
    {% elif section['slug'] == 'jabones' %}
      {% set knob_img = '/static/images/banner3.jpg' %}
    {% elif section['slug'] == 'otros' %}
      {% set knob_img = '/static/images/banner8.jpg' %}
    {% endif %}
    <a href="#{{ section['slug'] }}" class="aseo-knob">
      <span class="knob-circle"><img src="{{ knob_img }}" alt="{{ section['title'] }}" loading="lazy" decoding="async"></span>
      <span class="knob-name">{{ section['title'] }}</span>
    </a>
    {% endfor %}
  </nav>

  {% for section in sections %}
  <section class="aseo-section" id="{{ section['slug'] }}">
    <h2>{{ section['title'] }}</h2>
    {% if section['items'] %}
    <div class="aseo-row">
      {% for item in section['items'] %}
      <article class="aseo-card quick-card"
               data-item='{{ {"id": item.presentacion_id or ("aseo-" ~ item.producto_id), "producto": item.producto, "marca": item.marca, "presentacion": item.presentacion, "contenido": item.contenido, "imagen": item.imagen, "unit": item.precio_unit, "producto_id": item.producto_id, "subcat": section["title"]}|tojson|safe }}'>
        <div class="aseo-card-img">
          <img src="{{ item.imagen }}" alt="{{ item.producto }}" loading="lazy" decoding="async" fetchpriority="low" width="320" height="210" onerror="this.onerror=null; this.src='/static/images/placeholder.svg';">
        </div>
        <div class="aseo-card-info">
          <h3>{{ item.producto }}</h3>
          <p>{{ section['title'] }}</p>
          {% if item.precio_desde %}
          <span>Desde {{ item.precio_desde|cop }}</span>
          {% else %}
          <span>Precio por confirmar</span>
          {% endif %}
        </div>
        <div class="aseo-card-actions">
          <button type="button" class="aseo-mini-btn js-open">Detalle</button>
          <button type="button" class="aseo-mini-btn js-add">Carrito</button>
          <a href="/producto/{{ item.producto_id }}" class="aseo-mini-link">Ver</a>
        </div>
      </article>
      {% endfor %}
    </div>
    {% else %}
    <div class="aseo-empty-row">Pronto agregaremos productos de {{ section['title']|lower }}.</div>
    {% endif %}
  </section>
  {% endfor %}
  {% endif %}
</main>

<div class="aseo-quick-modal" id="aseoQuickModal" aria-hidden="true">
  <div class="aseo-quick-overlay" data-close></div>
  <div class="aseo-quick-sheet" role="dialog" aria-modal="true">
    <button class="aseo-quick-close" type="button" data-close aria-label="Cerrar">&times;</button>
    <div class="aseo-quick-body">
      <div class="aseo-quick-image">
        <img id="aseoQuickImg" src="/static/images/placeholder.svg" alt="Producto" onerror="this.onerror=null; this.src='/static/images/placeholder.svg';">
      </div>
      <div class="aseo-quick-info">
        <h3 id="aseoQuickName"></h3>
        <p id="aseoQuickSub"></p>
        <strong id="aseoQuickPrice">$0</strong>
        <div class="aseo-quick-qty">
          <button type="button" data-qty="-">-</button>
          <input type="number" id="aseoQuickQty" min="1" value="1">
          <button type="button" data-qty="+">+</button>
        </div>
        <div class="aseo-quick-actions">
          <button type="button" id="aseoQuickAdd">Agregar al carrito</button>
          <a id="aseoQuickView" href="/tienda">Ver detalle</a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const themeToggle = document.querySelector(".modo-nocturno");
  const setTheme = (isDark) => {
    document.body.classList.toggle("dark", isDark);
    if (themeToggle) themeToggle.innerHTML = isDark ? "&#9728;" : "&#9789;";
    localStorage.setItem("tema", isDark ? "dark" : "light");
  };
  const storedTheme = localStorage.getItem("tema");
  if (storedTheme) setTheme(storedTheme === "dark");
  if (themeToggle) {
    themeToggle.addEventListener("click", (e) => {
      e.preventDefault();
      setTheme(!document.body.classList.contains("dark"));
    });
  }

  const mainCats = document.querySelectorAll(".aseo-main-cat");
  if (mainCats.length) {
    const setFocus = (el) => {
      mainCats.forEach((c) => c.classList.remove("is-focus"));
      if (el) el.classList.add("is-focus");
    };
    mainCats.forEach((cat) => {
      cat.addEventListener("mouseenter", () => setFocus(cat));
      cat.addEventListener("focusin", () => setFocus(cat));
      cat.addEventListener("touchstart", () => setFocus(cat), { passive: true });
    });
  }

  const knobCats = document.querySelectorAll(".aseo-knob");
  if (knobCats.length) {
    knobCats.forEach((knob) => {
      knob.addEventListener("touchstart", () => {
        knobCats.forEach((k) => k.classList.remove("is-focus"));
        knob.classList.add("is-focus");
      }, { passive: true });
    });
  }

  const CART_KEY = "du_cart";
  const quickModal = document.getElementById("aseoQuickModal");
  const quickImg = document.getElementById("aseoQuickImg");
  const quickName = document.getElementById("aseoQuickName");
  const quickSub = document.getElementById("aseoQuickSub");
  const quickPrice = document.getElementById("aseoQuickPrice");
  const quickQty = document.getElementById("aseoQuickQty");
  const quickAdd = document.getElementById("aseoQuickAdd");
  const quickView = document.getElementById("aseoQuickView");
  let activeItem = null;

  const formatCOP = (value) => {
    const num = Number(value) || 0;
    return `$${num.toLocaleString("es-CO")}`.replace(/,/g, ".");
  };

  const addToCart = (item, qty) => {
    const stored = localStorage.getItem(CART_KEY);
    let cart = [];
    if (stored) {
      try { cart = JSON.parse(stored); } catch (e) { cart = []; }
    }
    const payload = {
      id: String(item.id || `aseo-${item.producto_id}`),
      producto: item.producto || "Producto",
      marca: item.marca || "Marca",
      presentacion: item.presentacion || "Presentacion",
      contenido: item.contenido || "",
      imagen: item.imagen || "/static/images/placeholder.svg",
      qty: qty,
      unit: Number(item.unit) || 0
    };
    const idx = cart.findIndex((c) => String(c.id) === String(payload.id));
    if (idx >= 0) {
      cart[idx].qty += payload.qty;
      cart[idx].unit = payload.unit;
    } else {
      cart.push(payload);
    }
    localStorage.setItem(CART_KEY, JSON.stringify(cart));
  };

  const closeQuick = () => {
    if (!quickModal) return;
    quickModal.classList.remove("open");
    quickModal.setAttribute("aria-hidden", "true");
    document.body.classList.remove("modal-open");
    activeItem = null;
    if (quickQty) quickQty.value = 1;
  };

  const openQuick = (item) => {
    if (!quickModal || !item) return;
    activeItem = item;
    if (quickImg) quickImg.src = item.imagen || "/static/images/placeholder.svg";
    if (quickName) quickName.textContent = item.producto || "Producto";
    if (quickSub) quickSub.textContent = `${item.subcat || "Aseo"} - ${item.presentacion || ""} ${item.contenido || ""}`.trim();
    if (quickPrice) quickPrice.textContent = formatCOP(item.unit || 0);
    if (quickView) quickView.href = `/producto/${item.producto_id || ""}`;
    if (quickQty) quickQty.value = 1;
    quickModal.classList.add("open");
    quickModal.setAttribute("aria-hidden", "false");
    document.body.classList.add("modal-open");
  };

  document.querySelectorAll(".quick-card").forEach((card) => {
    let touch = null;
    const readItem = () => {
      try { return JSON.parse(card.dataset.item || "{}"); } catch (e) { return null; }
    };

    const openFromCard = () => {
      const item = readItem();
      if (!item) return;
      openQuick(item);
    };

    const addFromCard = () => {
      const item = readItem();
      if (!item) return;
      addToCart(item, 1);
      card.classList.add("added");
      setTimeout(() => card.classList.remove("added"), 700);
    };

    const openBtn = card.querySelector(".js-open");
    const addBtn = card.querySelector(".js-add");
    if (openBtn) openBtn.addEventListener("click", (e) => { e.preventDefault(); e.stopPropagation(); openFromCard(); });
    if (addBtn) addBtn.addEventListener("click", (e) => { e.preventDefault(); e.stopPropagation(); addFromCard(); });

    card.addEventListener("click", (e) => {
      if (e.target.closest(".aseo-mini-btn") || e.target.closest(".aseo-mini-link")) return;
      openFromCard();
    });
    card.addEventListener("touchstart", (e) => {
      const t = e.changedTouches && e.changedTouches[0];
      if (!t) return;
      touch = { x: t.clientX, y: t.clientY };
    }, { passive: true });
    card.addEventListener("touchend", (e) => {
      if (!touch) return;
      const t = e.changedTouches && e.changedTouches[0];
      if (!t) return;
      const dx = Math.abs(t.clientX - touch.x);
      const dy = Math.abs(t.clientY - touch.y);
      touch = null;
      if (dx > 10 || dy > 10) return;
      if (e.target.closest(".aseo-mini-btn") || e.target.closest(".aseo-mini-link")) return;
      e.preventDefault();
      openFromCard();
    }, { passive: false });
  });

  if (quickModal) {
    quickModal.querySelectorAll("[data-close]").forEach((el) => el.addEventListener("click", closeQuick));
    quickModal.addEventListener("click", (e) => {
      if (!e.target.closest(".aseo-quick-sheet")) closeQuick();
    });
  }

  if (quickQty) {
    quickQty.addEventListener("input", () => {
      const n = Math.max(1, parseInt(quickQty.value || "1", 10) || 1);
      quickQty.value = n;
    });
  }
  document.querySelectorAll(".aseo-quick-qty button").forEach((btn) => {
    btn.addEventListener("click", () => {
      if (!quickQty) return;
      const d = btn.dataset.qty === "+" ? 1 : -1;
      const n = Math.max(1, parseInt(quickQty.value || "1", 10) + d);
      quickQty.value = n;
    });
  });
  if (quickAdd) {
    quickAdd.addEventListener("click", () => {
      if (!activeItem) return;
      const qty = quickQty ? Math.max(1, parseInt(quickQty.value || "1", 10) || 1) : 1;
      addToCart(activeItem, qty);
      quickAdd.textContent = "Agregado";
      setTimeout(() => { quickAdd.textContent = "Agregar al carrito"; }, 900);
    });
  }
</script>

</body>
</html>
