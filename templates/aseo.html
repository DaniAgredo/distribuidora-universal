<!DOCTYPE html>
<html lang="es">
<head>
<link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aseo - Distribuidora Universal</title>
<link rel="stylesheet" href="/static/style.css?v=20260214">
<link rel="stylesheet" href="/static/aseo.css?v=20260214">
</head>
<body class="pagina-aseo">

<header class="header aseo-header-wrap">
  <div class="fila-superior aseo-header">
    <div class="aseo-title">
      <span class="icono">&#127758;</span>
      <div class="nombre">Aseo</div>
    </div>
    <div class="acciones aseo-actions">
      <a href="https://wa.me/573215485315" class="whatsapp" target="_blank" rel="noopener" aria-label="WhatsApp">W</a>
      <a href="/" class="volver" aria-label="Volver">&#8592;</a>
      <a href="/tienda" class="carrito-mini" aria-label="Tienda">&#128722;</a>
      <a href="/cuenta" class="login" aria-label="Cuenta">&#128100;</a>
      <a href="#" class="modo-nocturno" aria-label="Modo nocturno">&#9789;</a>
    </div>
  </div>
</header>

<main class="aseo-main">
  {% if db_missing %}
  <div class="aseo-empty">
    <strong>Base de datos no encontrada.</strong>
    <p>No se pudo cargar el catalogo de aseo.</p>
  </div>
  {% else %}
  <nav class="aseo-main-cats" aria-label="Categorias principales">
    <a class="aseo-main-cat active" href="/aseo">
      <span class="cat-circle"><img src="/static/images/banner1.jpg" alt="Aseo" loading="lazy" decoding="async"></span>
      <span class="cat-name">Aseo</span>
    </a>
    <a class="aseo-main-cat" href="/tienda?cat=drogueria">
      <span class="cat-circle"><img src="/static/images/banner6.jpg" alt="Drogueria" loading="lazy" decoding="async"></span>
      <span class="cat-name">Drogueria</span>
    </a>
    <a class="aseo-main-cat" href="/tienda?cat=ferreteria">
      <span class="cat-circle"><img src="/static/images/banner3.jpg" alt="Ferreteria" loading="lazy" decoding="async"></span>
      <span class="cat-name">Ferreteria</span>
    </a>
    <a class="aseo-main-cat" href="/tienda?cat=papeleria">
      <span class="cat-circle"><img src="/static/images/banner8.jpg" alt="Papeleria" loading="lazy" decoding="async"></span>
      <span class="cat-name">Papeleria</span>
    </a>
    <a class="aseo-main-cat" href="/tienda?cat=comestibles">
      <span class="cat-circle"><img src="/static/images/banner2.jpg" alt="Abarrotes" loading="lazy" decoding="async"></span>
      <span class="cat-name">Abarrotes</span>
    </a>
    <a class="aseo-main-cat" href="/tienda?cat=insecticidas">
      <span class="cat-circle"><img src="/static/images/banner4.jpg" alt="Insecticidas" loading="lazy" decoding="async"></span>
      <span class="cat-name">Insecticidas</span>
    </a>
  </nav>

  <nav class="aseo-knobs" aria-label="Subcategorias de aseo">
    <a href="/tienda" class="aseo-knob aseo-knob-back">
      <span class="knob-circle" aria-hidden="true">&#8592;</span>
      <span class="knob-name">Devolver</span>
    </a>
    {% for section in sections %}
    {% set knob_img = '/static/images/banner1.jpg' %}
    {% if section['slug'] == 'lava-lozas' %}
      {% set knob_img = '/static/images/banner2.jpg' %}
    {% elif section['slug'] == 'limpidos' %}
      {% set knob_img = '/static/images/banner4.jpg' %}
    {% elif section['slug'] == 'jabones' %}
      {% set knob_img = '/static/images/banner3.jpg' %}
    {% elif section['slug'] == 'otros' %}
      {% set knob_img = '/static/images/banner8.jpg' %}
    {% endif %}
    <a href="#{{ section['slug'] }}" class="aseo-knob">
      <span class="knob-circle"><img src="{{ knob_img }}" alt="{{ section['title'] }}" loading="lazy" decoding="async"></span>
      <span class="knob-name">{{ section['title'] }}</span>
    </a>
    {% endfor %}
  </nav>

  {% for section in sections %}
  <section class="aseo-section" id="{{ section['slug'] }}">
    <h2>{{ section['title'] }}</h2>
    {% if section['items'] %}
    <div class="aseo-row">
      {% for item in section['items'] %}
      {% set item_nombre = (item.producto or '')|lower %}
      {% if 'revita' in item_nombre or 'revitacolor' in item_nombre %}
        {% set item_titulo = 'Ariel Revita Color' %}
        {% set item_img = '/static/images/ariel-revita.jpg?v=20260330' %}
      {% elif 'ariel' in item_nombre %}
        {% set item_titulo = 'Ariel Triple Poder' %}
        {% set item_img = item.imagen %}
      {% elif 'fab' in item_nombre and 'fabuloso' not in item_nombre %}
        {% set item_titulo = 'Fab Lavado Perfecto' %}
        {% set item_img = item.imagen %}
      {% elif '3d' in item_nombre %}
        {% set item_titulo = '3D Multiusos' %}
        {% set item_img = '/static/images/3d.jpg?v=20260330' %}
      {% else %}
        {% set item_titulo = item.producto %}
        {% set item_img = item.imagen %}
      {% endif %}
      <article class="aseo-card quick-card"
               data-item='{{ {"id": item.presentacion_id or ("aseo-" ~ item.producto_id), "producto": item_titulo, "marca": item.marca, "presentacion": item.presentacion, "contenido": item.contenido, "imagen": item_img, "unit": item.precio_unit, "producto_id": item.producto_id, "subcat": section["title"], "variantes": item.variantes}|tojson|safe }}'>
        <div class="aseo-card-img">
          <img src="{{ item_img }}" alt="{{ item_titulo }}" loading="lazy" decoding="async" fetchpriority="low" width="320" height="210" onerror="this.onerror=null; this.src='/static/images/placeholder.svg';">
        </div>
        <div class="aseo-card-info">
          <h3>{{ item_titulo }}</h3>
        </div>
      </article>
      {% endfor %}
    </div>
    {% else %}
    <div class="aseo-empty-row">Pronto agregaremos productos de {{ section['title']|lower }}.</div>
    {% endif %}
  </section>
  {% endfor %}
  {% endif %}
</main>

<div class="aseo-quick-modal" id="aseoQuickModal" aria-hidden="true">
  <div class="aseo-quick-overlay" data-close></div>
  <div class="aseo-quick-sheet" role="dialog" aria-modal="true">
    <button class="aseo-quick-close" type="button" data-close aria-label="Cerrar">&times;</button>
    <div class="aseo-quick-body">
      <div class="aseo-quick-image">
        <img id="aseoQuickImg" src="/static/images/placeholder.svg" alt="Producto" onerror="this.onerror=null; this.src='/static/images/placeholder.svg';">
      </div>
      <div class="aseo-quick-info">
        <span class="aseo-quick-tag" id="aseoQuickTag"></span>
        <h3 id="aseoQuickName"></h3>
        <p id="aseoQuickSub"></p>
        <div class="aseo-quick-variants" id="aseoQuickVariants"></div>
        <div class="aseo-quick-prices">
          <h4>Precio unitario</h4>
          <div class="aseo-price-grid" id="aseoQuickPriceList"></div>
        </div>
        <div class="aseo-quick-qty">
          <button type="button" data-qty="-">-</button>
          <input type="number" id="aseoQuickQty" min="1" value="1">
          <button type="button" data-qty="+">+</button>
        </div>
        <div class="aseo-quick-total">
          <span>Total</span>
          <strong id="aseoQuickTotal">$0</strong>
        </div>
        <div class="aseo-quick-actions">
          <button type="button" id="aseoQuickAdd">Agregar al carrito</button>
          <a id="aseoQuickView" href="/tienda">Ver detalle</a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const themeToggle = document.querySelector(".modo-nocturno");
  const setTheme = (isDark) => {
    document.body.classList.toggle("dark", isDark);
    if (themeToggle) themeToggle.innerHTML = isDark ? "&#9728;" : "&#9789;";
    localStorage.setItem("tema", isDark ? "dark" : "light");
  };
  const storedTheme = localStorage.getItem("tema");
  if (storedTheme) setTheme(storedTheme === "dark");
  if (themeToggle) {
    themeToggle.addEventListener("click", (e) => {
      e.preventDefault();
      setTheme(!document.body.classList.contains("dark"));
    });
  }

  const mainCats = document.querySelectorAll(".aseo-main-cat");
  if (mainCats.length) {
    const setFocus = (el) => {
      mainCats.forEach((c) => c.classList.remove("is-focus"));
      if (el) el.classList.add("is-focus");
    };
    mainCats.forEach((cat) => {
      cat.addEventListener("mouseenter", () => setFocus(cat));
      cat.addEventListener("focusin", () => setFocus(cat));
      cat.addEventListener("touchstart", () => setFocus(cat), { passive: true });
    });
  }

  const knobCats = document.querySelectorAll(".aseo-knob");
  if (knobCats.length) {
    knobCats.forEach((knob) => {
      knob.addEventListener("touchstart", () => {
        knobCats.forEach((k) => k.classList.remove("is-focus"));
        knob.classList.add("is-focus");
      }, { passive: true });
    });
  }

  const CART_KEY = "du_cart";
  const quickModal = document.getElementById("aseoQuickModal");
  const quickImg = document.getElementById("aseoQuickImg");
  const quickTag = document.getElementById("aseoQuickTag");
  const quickName = document.getElementById("aseoQuickName");
  const quickSub = document.getElementById("aseoQuickSub");
  const quickVariants = document.getElementById("aseoQuickVariants");
  const quickPriceList = document.getElementById("aseoQuickPriceList");
  const quickQty = document.getElementById("aseoQuickQty");
  const quickTotal = document.getElementById("aseoQuickTotal");
  const quickAdd = document.getElementById("aseoQuickAdd");
  const quickView = document.getElementById("aseoQuickView");
  let activeItem = null;
  let activeVariant = null;
  let activePriceTiers = [];

  const formatCOP = (value) => {
    const num = Number(value) || 0;
    return `$${num.toLocaleString("es-CO")}`.replace(/,/g, ".");
  };
  const sortTiers = (tiers) => [...(tiers || [])].sort((a, b) => (a.min_cantidad || 0) - (b.min_cantidad || 0));
  const getUnitPrice = (tiers, qty) => {
    const ordered = sortTiers(tiers);
    if (!ordered.length) return 0;
    let chosen = ordered[0];
    ordered.forEach((tier) => {
      if (qty >= (Number(tier.min_cantidad) || 1)) chosen = tier;
    });
    return Number(chosen.precio) || 0;
  };
  const buildFallbackTiers = (unit) => {
    const base = Number(unit) || 0;
    if (!base) return [];
    return [
      { min_cantidad: 1, precio: base },
      { min_cantidad: 6, precio: Math.max(1, Math.round(base * 0.96)) },
      { min_cantidad: 12, precio: Math.max(1, Math.round(base * 0.92)) }
    ];
  };
  const renderPrices = (tiers, qty = 1) => {
    if (!quickPriceList) return;
    quickPriceList.innerHTML = "";
    const ordered = sortTiers(tiers);
    if (!ordered.length) {
      const empty = document.createElement("div");
      empty.className = "aseo-price-empty";
      empty.textContent = "Precio disponible pronto";
      quickPriceList.appendChild(empty);
      return;
    }
    const chosen = ordered.reduce((acc, tier) => (qty >= (tier.min_cantidad || 1) ? tier : acc), ordered[0]);
    const main = document.createElement("div");
    main.className = "aseo-price-main";
    main.innerHTML = `<span>Valor unidad</span><strong>${formatCOP(chosen.precio)}</strong>`;
    quickPriceList.appendChild(main);
    const other = ordered.filter((tier) => tier.min_cantidad !== chosen.min_cantidad);
    if (other.length) {
      const options = document.createElement("div");
      options.className = "aseo-price-options";
      other.forEach((tier) => {
        const chip = document.createElement("span");
        chip.className = "aseo-price-chip";
        const label = Number(tier.min_cantidad) >= 12 ? "12+" : "6+";
        chip.innerHTML = `<span>${label}</span><strong>${formatCOP(tier.precio)}</strong>`;
        options.appendChild(chip);
      });
      quickPriceList.appendChild(options);
    }
  };
  const updateTotal = () => {
    if (!quickQty || !quickTotal) return;
    const qty = Math.max(1, parseInt(quickQty.value || "1", 10) || 1);
    quickQty.value = qty;
    const unit = getUnitPrice(activePriceTiers, qty);
    renderPrices(activePriceTiers, qty);
    quickTotal.textContent = unit ? formatCOP(unit * qty) : "$0";
  };

  const addToCart = (item, qty) => {
    const stored = localStorage.getItem(CART_KEY);
    let cart = [];
    if (stored) {
      try { cart = JSON.parse(stored); } catch (e) { cart = []; }
    }
    const payload = {
      id: String(item.id || `aseo-${item.producto_id}`),
      producto: item.producto || "Producto",
      marca: item.marca || "Marca",
      presentacion: item.presentacion || "Presentacion",
      contenido: item.contenido || "",
      imagen: item.imagen || "/static/images/placeholder.svg",
      qty: qty,
      unit: Number(item.unit) || 0
    };
    const idx = cart.findIndex((c) => String(c.id) === String(payload.id));
    if (idx >= 0) {
      cart[idx].qty += payload.qty;
      cart[idx].unit = payload.unit;
    } else {
      cart.push(payload);
    }
    localStorage.setItem(CART_KEY, JSON.stringify(cart));
  };

  const closeQuick = () => {
    if (!quickModal) return;
    quickModal.classList.remove("open");
    quickModal.setAttribute("aria-hidden", "true");
    document.body.classList.remove("modal-open");
    activeItem = null;
    activeVariant = null;
    activePriceTiers = [];
    if (quickImg) quickImg.classList.remove("is-pop");
    if (quickTag) quickTag.textContent = "";
    if (quickSub) quickSub.textContent = "";
    if (quickVariants) quickVariants.innerHTML = "";
    if (quickPriceList) quickPriceList.innerHTML = "";
    if (quickTotal) quickTotal.textContent = "$0";
    if (quickQty) quickQty.value = 1;
  };

  const selectVariant = (variant, item) => {
    if (!variant || !item) return;
    activeVariant = variant;
    if (quickTag) quickTag.textContent = variant.marca || item.marca || "";
    if (quickName) quickName.textContent = item.producto || "Producto";
    const detalle = `${variant.presentacion || ""} ${variant.contenido || ""}`.trim();
    if (quickSub) quickSub.textContent = detalle || (item.subcat || "Aseo");
    if (quickImg) {
      quickImg.src = variant.imagen || item.imagen || "/static/images/placeholder.svg";
      quickImg.classList.add("is-pop");
      setTimeout(() => quickImg && quickImg.classList.remove("is-pop"), 220);
    }
    activePriceTiers = (variant.precios && variant.precios.length) ? variant.precios : buildFallbackTiers(item.unit || 0);
    if (quickQty) quickQty.value = 1;
    if (quickAdd) {
      quickAdd.disabled = false;
      quickAdd.textContent = "Agregar al carrito";
    }
    updateTotal();
    if (quickVariants) {
      quickVariants.querySelectorAll(".aseo-variant").forEach((chip) => {
        chip.classList.toggle("active", chip.dataset.vid === String(variant.presentacion_id));
      });
    }
  };

  const openQuick = (item) => {
    if (!quickModal || !item) return;
    activeItem = item;
    if (quickView) quickView.href = `/producto/${item.producto_id || ""}`;
    const variants = Array.isArray(item.variantes) ? item.variantes : [];
    if (quickVariants) {
      quickVariants.innerHTML = "";
      variants.forEach((v) => {
        const chip = document.createElement("button");
        chip.type = "button";
        chip.className = "aseo-variant";
        chip.dataset.vid = String(v.presentacion_id || "");
        chip.innerHTML = `<span>${(v.presentacion || "").trim()}</span><strong>${(v.contenido || "").trim()}</strong>`;
        chip.addEventListener("click", () => selectVariant(v, item));
        quickVariants.appendChild(chip);
      });
    }
    const fallbackVariant = {
      presentacion_id: item.id || `aseo-${item.producto_id}`,
      presentacion: item.presentacion || "Presentacion",
      contenido: item.contenido || "",
      imagen: item.imagen || "/static/images/placeholder.svg",
      marca: item.marca || "",
      precios: buildFallbackTiers(item.unit || 0)
    };
    selectVariant(variants[0] || fallbackVariant, item);
    quickModal.classList.add("open");
    quickModal.setAttribute("aria-hidden", "false");
    document.body.classList.add("modal-open");
  };

  document.querySelectorAll(".aseo-row").forEach((row) => {
    const cards = Array.from(row.querySelectorAll(".aseo-card"));
    const activate = (card) => {
      row.classList.add("dimmed");
      cards.forEach((c) => c.classList.remove("active"));
      card.classList.add("active");
    };
    const clear = () => {
      row.classList.remove("dimmed");
      cards.forEach((c) => c.classList.remove("active"));
    };
    cards.forEach((card) => {
      card.addEventListener("mouseenter", () => activate(card));
      card.addEventListener("mouseleave", clear);
      card.addEventListener("focusin", () => activate(card));
      card.addEventListener("focusout", clear);
      card.addEventListener("touchstart", () => activate(card), { passive: true });
      card.addEventListener("touchend", () => setTimeout(clear, 700), { passive: true });
    });
    document.addEventListener("click", (e) => {
      if (!row.contains(e.target)) clear();
    });
  });

  document.querySelectorAll(".quick-card").forEach((card) => {
    let touch = null;
    const readItem = () => {
      try { return JSON.parse(card.dataset.item || "{}"); } catch (e) { return null; }
    };

    const openFromCard = () => {
      const item = readItem();
      if (!item) return;
      openQuick(item);
    };

    const addFromCard = () => {
      const item = readItem();
      if (!item) return;
      addToCart(item, 1);
      card.classList.add("added");
      setTimeout(() => card.classList.remove("added"), 700);
    };

    const openBtn = card.querySelector(".js-open");
    const addBtn = card.querySelector(".js-add");
    if (openBtn) openBtn.addEventListener("click", (e) => { e.preventDefault(); e.stopPropagation(); openFromCard(); });
    if (addBtn) addBtn.addEventListener("click", (e) => { e.preventDefault(); e.stopPropagation(); addFromCard(); });

    card.addEventListener("click", (e) => {
      const openedByTouchAt = Number(card.dataset.touchOpenAt || 0);
      if (openedByTouchAt && (Date.now() - openedByTouchAt) < 700) {
        e.preventDefault();
        return;
      }
      if (e.target.closest(".aseo-mini-btn") || e.target.closest(".aseo-mini-link")) return;
      openFromCard();
    });
    card.addEventListener("touchstart", (e) => {
      const t = e.changedTouches && e.changedTouches[0];
      if (!t) return;
      touch = { x: t.clientX, y: t.clientY, at: Date.now() };
    }, { passive: true });
    card.addEventListener("touchend", (e) => {
      if (!touch) return;
      const t = e.changedTouches && e.changedTouches[0];
      if (!t) return;
      const dx = Math.abs(t.clientX - touch.x);
      const dy = Math.abs(t.clientY - touch.y);
      const dt = Date.now() - touch.at;
      touch = null;
      if (dx > 12 || dy > 12 || dt > 550) return;
      if (e.target.closest(".aseo-mini-btn") || e.target.closest(".aseo-mini-link")) return;
      e.preventDefault();
      card.dataset.touchOpenAt = String(Date.now());
      openFromCard();
    }, { passive: false });
  });

  if (quickModal) {
    quickModal.querySelectorAll("[data-close]").forEach((el) => el.addEventListener("click", closeQuick));
    quickModal.addEventListener("click", (e) => {
      if (!e.target.closest(".aseo-quick-sheet")) closeQuick();
    });
  }

  if (quickQty) {
    quickQty.addEventListener("input", () => {
      const n = Math.max(1, parseInt(quickQty.value || "1", 10) || 1);
      quickQty.value = n;
      updateTotal();
    });
  }
  document.querySelectorAll(".aseo-quick-qty button").forEach((btn) => {
    btn.addEventListener("click", () => {
      if (!quickQty) return;
      const d = btn.dataset.qty === "+" ? 1 : -1;
      const n = Math.max(1, parseInt(quickQty.value || "1", 10) + d);
      quickQty.value = n;
      updateTotal();
    });
  });
  if (quickAdd) {
    quickAdd.addEventListener("click", () => {
      if (!activeItem || !activeVariant) return;
      const qty = quickQty ? Math.max(1, parseInt(quickQty.value || "1", 10) || 1) : 1;
      const unit = getUnitPrice(activePriceTiers, qty);
      addToCart(
        {
          id: activeVariant.presentacion_id || activeItem.id,
          producto: activeItem.producto || "Producto",
          marca: activeVariant.marca || activeItem.marca || "",
          presentacion: activeVariant.presentacion || activeItem.presentacion || "Presentacion",
          contenido: activeVariant.contenido || activeItem.contenido || "",
          imagen: activeVariant.imagen || activeItem.imagen || "/static/images/placeholder.svg",
          unit: unit || activeItem.unit || 0,
          producto_id: activeItem.producto_id || ""
        },
        qty
      );
      quickAdd.textContent = "Agregado";
      setTimeout(() => { quickAdd.textContent = "Agregar al carrito"; }, 900);
    });
  }

  if (quickImg) {
    quickImg.addEventListener("click", () => {
      quickImg.classList.add("is-pop");
      setTimeout(() => quickImg && quickImg.classList.remove("is-pop"), 220);
    });
  }
</script>

</body>
</html>

