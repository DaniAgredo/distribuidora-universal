<!DOCTYPE html>
<html lang="es">
<head>
<link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tienda - Distribuidora Universal</title>

<link rel="stylesheet" href="/static/style.css?v=20260214">
<link rel="stylesheet" href="/static/tienda.css?v=20260274">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>

<body class="pagina-tienda{% if not cat %} vista-todos{% endif %}">
{% set header_labels = {
  'aseo': 'Aseo',
  'drogueria': 'Drogueria',
  'ferreteria': 'Ferreteria',
  'papeleria': 'Papeleria',
  'comestibles': 'Comestibles',
  'cuidado-personal': 'Cuidado personal',
  'cuidado-adulto': 'Cuidado adulto',
  'insecticidas': 'Insecticidas y venenos',
  'juegos': 'Juegos',
  'varios': 'Varios'
} %}
{% if cat %}
  {% set header_title = header_labels.get(cat, cat|replace('-', ' ')|title) %}
{% else %}
  {% set header_title = 'Tienda Universal' %}
{% endif %}

<header class="header">
  <div class="fila-superior tienda-header">
    <div class="tienda-left">
      <div class="titulo tienda-title">
        <span class="icono">&#127758;</span>
        <div class="nombre">{{ header_title }}</div>
      </div>
      <form class="tienda-search tienda-search-mobile" method="get" action="/tienda">
        <input type="hidden" name="cat" value="{{ cat }}">
        <button class="tienda-btn" type="submit">Buscar</button>
        <button class="tienda-lupa" type="submit" aria-label="Buscar">
          <i class="icon-inline" aria-hidden="true">&#128269;</i>
        </button>
        <input class="tienda-input" type="text" name="q" value="{{ q }}" placeholder="Buscar productos, marcas o categorias...">
        <button class="tienda-clear" type="button" aria-label="Borrar">
          <i class="icon-inline" aria-hidden="true">&times;</i>
        </button>
        <button class="tienda-camera" type="button" aria-label="Buscar con camara">
          <i class="icon-inline" aria-hidden="true">&#128247;</i>
        </button>
        <input class="tienda-camera-input" type="file" accept="image/*" capture="environment">
      </form>
    </div>
    <div class="acciones tienda-acciones">
      <a href="https://wa.me/573215485315" class="whatsapp" target="_blank" rel="noopener">
        <i class="fa-brands fa-whatsapp" aria-hidden="true"></i>
        <span class="whatsapp-saludo">WhatsApp</span>
      </a>
      <a href="/carrito" class="carrito-link"><i class="icon-inline" aria-hidden="true">&#128722;</i> Carrito <span id="cartCount">0</span></a>
      <a href="/cuenta" class="login"><i class="icon-inline login-icon" aria-hidden="true">&#128100;</i> <span class="login-text">Cuenta</span></a>
      <a href="#" class="modo-nocturno" aria-label="Modo nocturno">
        <i class="icon-inline" aria-hidden="true">&#9789;</i>
      </a>
    </div>
  </div>
</header>

<nav class="floating-arrows" aria-label="Navegacion">
  <a href="/" class="floating-arrow floating-arrow-left" aria-label="Volver al inicio">&#10094;</a>
  <a href="/carrito" class="floating-arrow floating-arrow-right" aria-label="Ir al carrito">&#10095;</a>
</nav>

<main class="tienda-main">
  {% set cat_images = [
    '/static/images/banner1.jpg',
    '/static/images/banner2.jpg',
    '/static/images/banner3.jpg',
    '/static/images/banner4.jpg',
    '/static/images/banner5.jpg',
    '/static/images/banner6.jpg',
    '/static/images/banner7.jpg',
    '/static/images/banner8.jpg'
  ] %}
  {% set cat_labels = {
    'comestibles': 'Abarrotes',
    'cuidado-adulto': 'Cuidado adulto',
    'insecticidas': 'Insecticidas y venenos',
    'juegos': 'Juegos'
  } %}
  <section class="tienda-chips" aria-label="Categorias">
    <div class="chips-story" data-active-cat="{{ cat }}" data-current-q="{{ q }}">
      <a class="chip-story chip-home {% if not cat %}active{% endif %}" data-cat="" href="/tienda">
        <span class="chip-circle">
          <img src="/static/images/estante.jfif" alt="Todos" loading="lazy">
        </span>
        <span class="chip-name">Catalogo</span>
      </a>
      {% if categorias %}
        {% set existing = categorias|map(attribute='slug')|list %}
        {% for c in categorias %}
        {% set nombre_categoria = cat_labels.get(c.slug, c.nombre) %}
        <a class="chip-story {% if cat == c.slug %}active{% endif %}" data-cat="{{ c.slug }}" href="/tienda?cat={{ c.slug }}{% if q %}&q={{ q|urlencode }}{% endif %}">
          <span class="chip-circle">
            <img src="{{ cat_images[loop.index0 % cat_images|length] }}" alt="{{ nombre_categoria }}" loading="lazy">
          </span>
          <span class="chip-name">{{ nombre_categoria }}</span>
        </a>
        {% endfor %}
        {% if 'juegos' not in existing %}
        <a class="chip-story {% if cat == 'juegos' %}active{% endif %}" data-cat="juegos" href="/tienda?cat=juegos{% if q %}&q={{ q|urlencode }}{% endif %}">
          <span class="chip-circle">
            <img src="{{ cat_images[0] }}" alt="Juegos" loading="lazy">
          </span>
          <span class="chip-name">Juegos</span>
        </a>
        {% endif %}
        {% if 'cuidado-adulto' not in existing %}
        <a class="chip-story {% if cat == 'cuidado-adulto' %}active{% endif %}" data-cat="cuidado-adulto" href="/tienda?cat=cuidado-adulto{% if q %}&q={{ q|urlencode }}{% endif %}">
          <span class="chip-circle">
            <img src="{{ cat_images[1] }}" alt="Cuidado adulto" loading="lazy">
          </span>
          <span class="chip-name">Cuidado adulto</span>
        </a>
        {% endif %}
        {% if 'insecticidas' not in existing %}
        <a class="chip-story {% if cat == 'insecticidas' %}active{% endif %}" data-cat="insecticidas" href="/tienda?cat=insecticidas{% if q %}&q={{ q|urlencode }}{% endif %}">
          <span class="chip-circle">
            <img src="{{ cat_images[2] }}" alt="Insecticidas y venenos" loading="lazy">
          </span>
          <span class="chip-name">Insecticidas y venenos</span>
        </a>
        {% endif %}
      {% else %}
        {% set fallback = [
          ('aseo','Aseo'),
          ('drogueria','Droguer&iacute;a'),
          ('ferreteria','Ferreter&iacute;a'),
          ('papeleria','Papeler&iacute;a'),
          ('cuidado-bebes','Cuidado beb&eacute;s'),
          ('cuidado-adulto','Cuidado adulto'),
          ('abarrotes','Abarrotes'),
          ('juegos','Juegos'),
          ('insecticidas','Insecticidas y venenos'),
          ('varios','Varios')
        ] %}
        {% for slug, nombre in fallback %}
        <a class="chip-story {% if cat == slug %}active{% endif %}" data-cat="{{ slug }}" href="/tienda?cat={{ slug }}{% if q %}&q={{ q|urlencode }}{% endif %}">
          <span class="chip-circle">
            <img src="{{ cat_images[loop.index0 % cat_images|length] }}" alt="{{ nombre }}" loading="lazy">
          </span>
          <span class="chip-name">{{ nombre }}</span>
        </a>
        {% endfor %}
      {% endif %}
    </div>
    <div class="tienda-resumen">
      {% if not db_missing %}
        <span>{{ total }} articulos</span>
      {% endif %}
    </div>
  </section>
  <script>
    if ('scrollRestoration' in history) {
      history.scrollRestoration = 'manual';
    }
    const navEntry = (performance.getEntriesByType && performance.getEntriesByType('navigation')[0]) || null;
    if (navEntry && navEntry.type === 'reload') {
      window.scrollTo({ top: 0, left: 0, behavior: 'auto' });
    }

    const chipsWrap = document.querySelector('.chips-story');
    if (chipsWrap) {
      const updateFocus = () => {
        const rect = chipsWrap.getBoundingClientRect();
        const center = rect.left + rect.width / 2;
        let best = null;
        let bestDist = Infinity;
        chipsWrap.querySelectorAll('.chip-story').forEach((chip) => {
          const cRect = chip.getBoundingClientRect();
          const cCenter = cRect.left + cRect.width / 2;
          const dist = Math.abs(center - cCenter);
          if (dist < bestDist) {
            bestDist = dist;
            best = chip;
          }
        });
        chipsWrap.querySelectorAll('.chip-story.is-focus').forEach((el) => el.classList.remove('is-focus'));
        if (best) best.classList.add('is-focus');
      };
      chipsWrap.addEventListener('scroll', () => {
        window.requestAnimationFrame(updateFocus);
      });
      chipsWrap.addEventListener('touchstart', updateFocus, { passive: true });
      window.addEventListener('resize', updateFocus);
      updateFocus();
    }

    const subcatImages = [
      '/static/images/banner1.jpg',
      '/static/images/banner2.jpg',
      '/static/images/banner3.jpg',
      '/static/images/banner4.jpg',
      '/static/images/banner5.jpg',
      '/static/images/banner6.jpg',
      '/static/images/banner7.jpg',
      '/static/images/banner8.jpg'
    ];
    const subcatsMap = {
      'aseo': [
        { label: 'Detergentes', img: '/static/images/ariel-thumb.jpg', anchor: 'sub-detergentes' },
        { label: 'Lava loza', img: '/static/images/axion.jpg', anchor: 'sub-lava-lozas' },
        { label: 'Jabon liquido', img: '/static/images/losa-crem.jpg', anchor: 'sub-jabon-liquido' },
        { label: 'Suavizantes', img: '/static/images/suavitel-tarro.png', anchor: 'sub-suavizantes' },
        { label: 'Desinfectantes', img: '/static/images/limpido.png', anchor: 'sub-otros' }
      ],
      'drogueria': [
        { label: 'Jabones en barra', img: '/static/images/barrigon.jpg', anchor: 'sub-jabones-barra' }
      ],
      'cuidado-bebes': [
        { label: 'Panales', q: 'panal', img: '/static/images/banner11.jpg' },
        { label: 'Toallitas', q: 'toallitas', img: '/static/images/banner12.jpg' },
        { label: 'Cremas', q: 'crema', img: '/static/images/banner13.jpg' }
      ],
      'cuidado-adulto': [
        { label: 'Panales', q: 'panal', img: '/static/images/banner14.jpg' },
        { label: 'Protectores', q: 'protector', img: '/static/images/banner15.jpg' },
        { label: 'Humedas', q: 'toallitas', img: '/static/images/banner16.jpg' }
      ]
    };

    if (chipsWrap) {
      const activeCat = chipsWrap.dataset.activeCat || '';
      const currentQ = chipsWrap.dataset.currentQ || '';
      const list = subcatsMap[activeCat];
      if (activeCat && list && list.length) {
        chipsWrap.classList.add('subcats-only');
        chipsWrap.innerHTML = '';
        const volver = document.createElement('a');
        volver.className = 'chip-story chip-volver';
        volver.href = currentQ ? `/tienda?q=${encodeURIComponent(currentQ)}` : '/tienda';
        volver.innerHTML = '<span class="chip-circle"><img src="/static/images/estante.jfif" alt="Volver"></span><span class="chip-name">Secciones</span>';
        chipsWrap.appendChild(volver);
        list.forEach((item, idx) => {
          const img = item.img || subcatImages[idx % subcatImages.length];
          const a = document.createElement('a');
          a.className = 'chip-story subcat';
          if (item.anchor) {
            a.href = `/tienda?cat=${encodeURIComponent(activeCat)}#${encodeURIComponent(item.anchor)}`;
          } else {
            a.href = `/tienda?cat=${encodeURIComponent(activeCat)}&q=${encodeURIComponent(item.q)}`;
          }
          a.innerHTML = `<span class="chip-circle"><img src="${img}" alt="${item.label}"></span><span class="chip-name">${item.label}</span>`;
          chipsWrap.appendChild(a);
        });
      }
    }

    const promoteSubcatChip = (chip) => {
      if (!chipsWrap || !chip || !chip.classList.contains('subcat')) return;
      const volver = chipsWrap.querySelector('.chip-volver');
      if (volver && chip !== volver.nextElementSibling) {
        chipsWrap.insertBefore(chip, volver.nextElementSibling);
      }
      chip.classList.add('is-picked');
      setTimeout(() => chip.classList.remove('is-picked'), 360);
      chipsWrap.scrollTo({ left: 0, behavior: 'smooth' });
    };

    const jumpToSubSection = (anchorId, chip = null) => {
      if (!anchorId) return false;
      if (typeof window.__prioritizeAseoSection === 'function') {
        const done = window.__prioritizeAseoSection(anchorId, chip);
        if (done) return true;
      }
      const target = document.getElementById(anchorId);
      if (!target) return false;
      if (chip) promoteSubcatChip(chip);
      target.classList.remove('is-jump');
      void target.offsetWidth;
      target.classList.add('is-jump');
      setTimeout(() => target.classList.remove('is-jump'), 420);
      target.scrollIntoView({ behavior: 'smooth', block: 'start' });
      return true;
    };

    // Cambio de categoria sin parpadeo
    const bindCategoryTransition = () => {
      let navLocked = false;
      const prefetched = new Set();
      const prefetchDoc = (href) => {
        if (!href || prefetched.has(href) || href.startsWith('#')) return;
        prefetched.add(href);
        const link = document.createElement('link');
        link.rel = 'prefetch';
        link.href = href;
        link.as = 'document';
        document.head.appendChild(link);
      };
      document.querySelectorAll('.chips-story a').forEach((link) => {
        const href = link.getAttribute('href');
        if (href) {
          link.addEventListener('mouseenter', () => prefetchDoc(href), { passive: true });
          link.addEventListener('touchstart', () => prefetchDoc(href), { passive: true });
        }
        link.addEventListener('click', (e) => {
          if (window.matchMedia('(max-width: 650px)').matches) {
            const trigger = chipsWrap ? chipsWrap.querySelector('.chip-story') : null;
            if (trigger && link === trigger && !document.body.classList.contains('chips-open')) {
              e.preventDefault();
              return;
            }
          }
          if (navLocked) return;
          if (e.button !== 0 || e.metaKey || e.ctrlKey || e.shiftKey || e.altKey) return;
          const href = link.getAttribute('href');
          if (!href || href.startsWith('#')) return;
          if (href.includes('#sub-')) {
            const url = new URL(href, window.location.origin);
            const targetCat = (url.searchParams.get('cat') || '').toLowerCase();
            const activeCat = (chipsWrap?.dataset.activeCat || '').toLowerCase();
            const anchorId = (url.hash || '').replace('#', '');
            if (url.pathname === window.location.pathname && targetCat && targetCat === activeCat) {
              e.preventDefault();
              jumpToSubSection(anchorId, link);
              history.replaceState(null, '', `${url.pathname}${url.search}`);
            }
            return;
          }
          e.preventDefault();
          navLocked = true;
          window.location.assign(href);
        });
      });
    };
    bindCategoryTransition();

    const buildAseoMobileSections = () => {
      if (!chipsWrap) return;
      const activeCat = chipsWrap.dataset.activeCat || '';
      if (!['aseo', 'drogueria'].includes(activeCat)) return;
      const grid = document.querySelector('.tienda-grid');
      if (!grid || document.querySelector('.aseo-mobile-sections')) return;
      const cards = Array.from(grid.querySelectorAll('.tienda-card'));
      const aseoDefs = [
        {
          key: 'detergentes',
          title: 'Detergentes',
          test: (name) => /(deterg|ariel|fab|3d|multiusos)/.test(name),
          fallback: [
            {
              key: 'ak1polvo',
              nombre: 'AK1 Polvo',
              imagen: '/static/images/ak1polvo.jpg',
              quickType: 'ak1polvo',
              variantes: [
                { presentacion_id: 'ak1polvo-900', marca: 'AK1', presentacion: 'AK1 Polvo', contenido: '900 g' }
              ]
            },
          ]
        },
        {
          key: 'lava-lozas',
          title: 'Lava lozas',
          test: (name) => /(lava ?loza|lavaloza|lavaplat|lozacrem|axion|dona ?lupe|doÃ±a ?lupe|lupe)/.test(name),
          fallback: [
            {
              key: 'lozacrem',
              nombre: 'Lozacrem',
              imagen: '/static/images/lozacrem.jpg',
              quickType: 'lozacrem',
              variantes: [
                { presentacion_id: 'lozacrem-1500', marca: 'Lozacrem', presentacion: 'Lozacrem', contenido: '1.5 L' },
                { presentacion_id: 'lozacrem-720', marca: 'Lozacrem', presentacion: 'Lozacrem', contenido: '720 ml' },
                { presentacion_id: 'lozacrem-250', marca: 'Lozacrem', presentacion: 'Lozacrem', contenido: '250 g' }
              ]
            },
            {
              key: 'axion',
              nombre: 'Axion',
              imagen: '/static/images/axion.jpg',
              quickType: 'axion',
              variantes: [
                { presentacion_id: 'axion-900', marca: 'Axion', presentacion: 'Axion', contenido: '900 g' },
                { presentacion_id: 'axion-450', marca: 'Axion', presentacion: 'Axion', contenido: '450 g' },
                { presentacion_id: 'axion-200', marca: 'Axion', presentacion: 'Axion', contenido: '200 g' }
              ]
            },
            {
              key: 'donalupe',
              nombre: 'Dona Lupe',
              imagen: '/static/images/do%C3%B1alupe.png',
              quickType: 'donalupe',
              variantes: [
                { presentacion_id: 'donalupe-900', marca: 'Dona Lupe', presentacion: 'Dona Lupe', contenido: '900 g' }
              ]
            },
            {
              key: 'supremo-barra',
              nombre: 'Supremo Barra',
              imagen: '/static/images/supremo-ba.png',
              quickType: 'supremo-barra',
              variantes: [
                { presentacion_id: 'supremo-barra-500', marca: 'Supremo', presentacion: 'Supremo Barra', contenido: '500 g' }
              ]
            }
          ]
        },
        {
          key: 'jabon-liquido',
          title: 'Jabon liquido',
          test: (name) => /(jabon liq|liquido|losa-?crem|3d-?liquido|ak1)/.test(name),
          fallback: [
            {
              key: 'losa-crem-liq',
              nombre: 'Losa-Crem Liquido',
              imagen: '/static/images/losa-crem.jpg',
              quickType: 'losa-crem-liq',
              variantes: [
                { presentacion_id: 'losa-crem-liq-900', marca: 'Losa-Crem', presentacion: 'Losa-Crem Liquido', contenido: '900 ml' }
              ]
            },
            {
              key: '3d-liquido',
              nombre: '3D Liquido',
              imagen: '/static/images/3d-liquido.jpg',
              quickType: '3d-liquido',
              variantes: [
                { presentacion_id: '3d-liquido-900', marca: '3D', presentacion: '3D Liquido', contenido: '900 ml' }
              ]
            },
            {
              key: 'ak1-liquido',
              nombre: 'AK1 Liquido',
              imagen: '/static/images/ak1.jpg',
              quickType: 'ak1-liquido',
              variantes: [
                { presentacion_id: 'ak1-liquido-900', marca: 'AK1', presentacion: 'AK1 Liquido', contenido: '900 ml' }
              ]
            }
          ]
        },
        {
          key: 'suavizantes',
          title: 'Suavizantes',
          test: (name) => /(suavitel|suavizante|suavisante|suavizador)/.test(name),
          fallback: [
            {
              key: 'suavitel-tarro',
              nombre: 'Suavitel Tarro',
              imagen: '/static/images/suavitel-tarro.png',
              quickType: 'suavitel-tarro',
              variantes: [
                { presentacion_id: 'suavitel-tarro-frasco', marca: 'Suavitel', presentacion: 'Suavitel Tarro', contenido: 'Frasco 1 L' },
                { presentacion_id: 'suavitel-tarro-rosas', marca: 'Suavitel', presentacion: 'Suavitel Bolsa Rosas', contenido: 'Bolsa Rosas 900 ml' }
              ]
            },
            {
              key: 'suavitel-sin-t',
              nombre: 'Suavitel Repuesto',
              imagen: '/static/images/suavitel-sin-t.png',
              quickType: 'suavitel-sin-t',
              variantes: [
                { presentacion_id: 'suavitel-sin-t-rosas', marca: 'Suavitel', presentacion: 'Suavitel Repuesto', contenido: 'Rosas 900 ml' },
                { presentacion_id: 'suavitel-sin-t-lavanda', marca: 'Suavitel', presentacion: 'Suavitel Repuesto', contenido: 'Lavanda 900 ml' },
                { presentacion_id: 'suavitel-sin-t-primavera', marca: 'Suavitel', presentacion: 'Suavitel Repuesto', contenido: 'Primavera 900 ml' },
                { presentacion_id: 'suavitel-sin-t-brisa', marca: 'Suavitel', presentacion: 'Suavitel Repuesto', contenido: 'Brisa 900 ml' }
              ]
            },
            {
              key: 'suavitel-con-t',
              nombre: 'Suavitel Repuesto c/Tapa',
              imagen: '/static/images/suavitel-con-t.png',
              quickType: 'suavitel-con-t',
              variantes: [
                { presentacion_id: 'suavitel-con-t-rosas', marca: 'Suavitel', presentacion: 'Suavitel c/Tapa', contenido: 'Rosas 900 ml' },
                { presentacion_id: 'suavitel-con-t-lavanda', marca: 'Suavitel', presentacion: 'Suavitel c/Tapa', contenido: 'Lavanda 900 ml' },
                { presentacion_id: 'suavitel-con-t-primavera', marca: 'Suavitel', presentacion: 'Suavitel c/Tapa', contenido: 'Primavera 900 ml' },
                { presentacion_id: 'suavitel-con-t-brisa', marca: 'Suavitel', presentacion: 'Suavitel c/Tapa', contenido: 'Brisa 900 ml' }
              ]
            }
          ]
        },
        {
          key: 'otros',
          title: 'Desinfectantes',
          test: () => true,
          fallback: [
            {
              key: 'limpido-gde',
              nombre: 'Limpido 1 L',
              imagen: '/static/images/limpido.png',
              quickType: 'limpido',
              variantes: [
                { presentacion_id: 'limpido-1000', marca: 'Limpido', presentacion: 'Limpido', contenido: '1 L' },
                { presentacion_id: 'limpido-500', marca: 'Limpido', presentacion: 'Limpido', contenido: '500 ml' }
              ]
            },
            {
              key: 'limpido-peq',
              nombre: 'Limpido 500 ml',
              imagen: '/static/images/limpidopeq.png',
              quickType: 'limpido',
              variantes: [
                { presentacion_id: 'limpido-1000', marca: 'Limpido', presentacion: 'Limpido', contenido: '1 L' },
                { presentacion_id: 'limpido-500', marca: 'Limpido', presentacion: 'Limpido', contenido: '500 ml' }
              ]
            }
          ]
        }
      ];
      const drogueriaDefs = [
        {
          key: 'jabones-barra',
          title: 'Jabones en barra',
          test: (name) => /(barrigon|barrig[oó]n|coco|rosa|vel-?rosa|jabon barra|jab[oó]n barra)/.test(name),
          fallback: [
            {
              key: 'barrigon',
              nombre: 'Barrigón',
              imagen: '/static/images/barrigon.jpg',
              quickType: 'barrigon',
              variantes: [
                { presentacion_id: 'barrigon-300', marca: 'Barrigón', presentacion: 'Jabón Barrigón', contenido: '300 g' }
              ]
            },
            {
              key: 'coco',
              nombre: 'Jabón Coco',
              imagen: '/static/images/coco.jpg',
              quickType: 'coco',
              variantes: [
                { presentacion_id: 'coco-300', marca: 'Coco', presentacion: 'Jabón Coco', contenido: '300 g' }
              ]
            },
            {
              key: 'vel-rosa',
              nombre: 'Vela Rosa',
              imagen: '/static/images/vel-rosa.jpg',
              quickType: 'vel-rosa',
              variantes: [
                { presentacion_id: 'vel-rosa-300', marca: 'Vela Rosa', presentacion: 'Jabón Vela Rosa', contenido: '300 g' }
              ]
            }
          ]
        }
      ];
      const defs = activeCat === 'aseo' ? aseoDefs : drogueriaDefs;
      if (!cards.length && !defs.some((d) => d.fallback && d.fallback.length)) return;

      const buckets = {};
      defs.forEach((def) => { buckets[def.key] = []; });
      cards.forEach((card) => {
        const name = (card.dataset.producto || '').toLowerCase();
        const def = defs.find((d) => d.key !== 'otros' && d.test(name));
        if (def) buckets[def.key].push(card);
        else if (buckets.otros) buckets.otros.push(card);
      });

      const wrap = document.createElement('section');
      wrap.className = 'aseo-mobile-sections';
      const makePreviewCard = (item) => {
        const card = document.createElement('article');
        const imgKey = (item.imagen || '').toLowerCase();
        const rawName = item.nombre || 'Producto';
        const cleanName = /lupe/i.test(rawName) ? 'Dona Lupe' : rawName;
        let type = item.quickType || 'item';
        if (!item.quickType) {
          if (imgKey.includes('axion')) type = 'axion';
          else if (imgKey.includes('lozacrem')) type = 'lozacrem';
          else if (imgKey.includes('lupe')) type = 'donalupe';
          else if (imgKey.includes('limpido')) type = 'limpido';
          else if (imgKey.includes('ak1')) type = 'ak1polvo';
          else if (imgKey.includes('suavitel')) type = 'suavitel-tarro';
          else if (imgKey.includes('supremo')) type = 'supremo-barra';
          else if (imgKey.includes('barrigon')) type = 'barrigon';
          else if (imgKey.includes('coco')) type = 'coco';
          else if (imgKey.includes('vel-rosa') || imgKey.includes('rosa')) type = 'vel-rosa';
        }
        card.className = `tienda-card focusable quick-view lava-preview-card lava-${type}`;
        card.dataset.quickType = item.quickType || type;
        card.dataset.producto = cleanName;
        card.dataset.categoria = activeCat === 'aseo' ? 'Aseo' : 'Drogueria';
        card.dataset.variantes = JSON.stringify(item.variantes || []);
        card.tabIndex = 0;
        card.innerHTML = `
          <div class="tienda-img">
            <img src="${item.imagen}" alt="${cleanName}" loading="lazy" decoding="async" onerror="if(document.body.classList.contains('vista-todos')){const card=this.closest('.tienda-card'); if(card) card.remove();} else {this.onerror=null; this.src='/static/images/placeholder.svg';}">
          </div>
          <div class="tienda-info">
            <h3>${cleanName}</h3>
          </div>
        `;
        return card;
      };

      defs.forEach((def) => {
        const list = buckets[def.key] || [];
        if (!list.length && !(def.fallback && def.fallback.length)) return;

        const section = document.createElement('section');
        section.className = 'aseo-mobile-section';
        section.id = `sub-${def.key}`;
        section.innerHTML = `<h2>${def.title}</h2>`;
        const row = document.createElement('div');
        row.className = 'aseo-mobile-row';

        if (list.length) {
          list.forEach((card) => row.appendChild(card));
        }
        if (def.fallback && def.fallback.length) {
          const existingNames = new Set(
            Array.from(row.querySelectorAll('.tienda-card')).map((card) => (card.dataset.producto || '').toLowerCase().trim())
          );
          def.fallback.forEach((item) => {
            const keyName = (item.nombre || '').toLowerCase().trim();
            if (keyName && existingNames.has(keyName)) return;
            row.appendChild(makePreviewCard(item));
          });
        }
        if (!row.children.length) {
          const empty = document.createElement('div');
          empty.className = 'aseo-mobile-empty';
          empty.textContent = `Pronto agregaremos productos de ${def.title.toLowerCase()}.`;
          row.appendChild(empty);
        }

        section.appendChild(row);
        wrap.appendChild(section);
      });

      const prioritizeAseoSection = (anchorId, chip = null) => {
        if (!anchorId) return false;
        const target = document.getElementById(anchorId);
        if (!target || !wrap.contains(target)) return false;
        if (chip) promoteSubcatChip(chip);
        const first = wrap.querySelector('.aseo-mobile-section');
        if (first && first !== target) {
          target.classList.remove('is-priority');
          wrap.insertBefore(target, first);
        }
        void target.offsetWidth;
        target.classList.add('is-priority');
        setTimeout(() => target.classList.remove('is-priority'), 420);
        return true;
      };
      window.__prioritizeAseoSection = prioritizeAseoSection;

      grid.before(wrap);
      document.body.classList.add('aseo-sections-mode');
      const hashTarget = (window.location.hash || '').replace('#', '');
      if (hashTarget) {
        const activeChip = chipsWrap ? chipsWrap.querySelector(`a[href*="#${hashTarget}"]`) : null;
        requestAnimationFrame(() => {
          prioritizeAseoSection(hashTarget, activeChip);
          history.replaceState(null, '', `${window.location.pathname}${window.location.search}`);
        });
      }
    };

    window.__buildAseoMobileSections = buildAseoMobileSections;
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', buildAseoMobileSections);
    } else {
      buildAseoMobileSections();
    }
  </script>

  {% if db_missing %}
  <div class="tienda-empty">
    <strong>Base de datos no encontrada.</strong>
    <p>Ejecuta el script para crear el catalogo.</p>
  </div>
  {% endif %}

  {% if not db_missing %}
  <section class="tienda-grid" aria-label="Listado de productos">
    {% set added_revita = false %}
    {% set added_fab = false %}
    {% set added_3d = false %}
    {% if items %}
      {% for item in items %}
      {% set producto_nombre = (item.producto or '')|lower %}
      {% set producto_categoria = (item.categoria or '')|lower %}
      {% set producto_imagen = item.imagen or '/static/images/placeholder.svg' %}
      {% set is_ariel = 'ariel' in producto_nombre %}
      {% set is_revita = 'revita' in producto_nombre or 'revitacolor' in producto_nombre %}
      {% set is_fab = 'fab' in producto_nombre and 'fabuloso' not in producto_nombre %}
      {% set is_3d = '3d' in producto_nombre %}
      {% set is_axion = 'axion' in producto_nombre %}
      {% set is_lozacrem = 'lozacrem' in producto_nombre %}
      {% set is_limpido = 'limpido' in producto_nombre %}
      {% set is_donalupe = 'dona lupe' in producto_nombre or 'doÃ±a lupe' in producto_nombre or 'donalupe' in producto_nombre %}
      {% if is_revita %}
        {% set producto_imagen = '/static/images/ariel-revita-thumb.jpg' %}
        {% set added_revita = true %}
      {% elif is_fab %}
        {% set producto_imagen = '/static/images/fab-thumb.jpg' %}
        {% set added_fab = true %}
      {% elif is_3d %}
        {% set producto_imagen = '/static/images/3d-thumb.jpg' %}
        {% set added_3d = true %}
      {% elif is_axion %}
        {% set producto_imagen = '/static/images/axion.jpg' %}
      {% elif is_lozacrem %}
        {% set producto_imagen = '/static/images/lozacrem.jpg' %}
      {% elif is_donalupe %}
        {% set producto_imagen = '/static/images/do%C3%B1alupe.png' %}
      {% elif is_ariel %}
        {% set producto_imagen = '/static/images/ariel-thumb.jpg' %}
      {% endif %}
      {% set producto_variantes = variants_by_product.get(item.producto_id, []) %}
      {% set is_quick = is_ariel or is_revita or is_fab or is_3d %}
      <a class="tienda-card {% if is_quick %}focusable quick-view{% endif %} {% if is_limpido %}is-limpido{% endif %}"
         href="/producto/{{ item.producto_id }}"
         data-producto="{{ item.producto }}"
         data-categoria="{{ item.categoria }}"
         {% if is_quick %}data-quick-type="{% if is_revita %}revita{% elif is_fab %}fab{% elif is_3d %}3d{% elif is_ariel %}ariel{% endif %}"{% endif %}
         {% if is_quick %}data-variantes='{{ producto_variantes|tojson }}'{% endif %}>
        <div class="tienda-img">
          <img src="{{ producto_imagen }}" alt="{{ item.producto }}" loading="lazy" decoding="async" fetchpriority="low" width="640" height="420" onerror="if(document.body.classList.contains('vista-todos')){const card=this.closest('.tienda-card'); if(card) card.remove();} else {this.onerror=null; this.src='/static/images/placeholder.svg';}">
        </div>
      <div class="tienda-info">
          <h3>
            {% if is_revita %}Ariel Revita Color
            {% elif is_fab %}Fab Lavado Perfecto
            {% elif is_3d %}3D Multiusos
            {% elif is_ariel %}Ariel Triple Poder
            {% else %}{{ item.producto }}
            {% endif %}
          </h3>
          <p>
            {% if is_revita or is_ariel or is_fab or is_3d %}
            {% else %}
              {{ item.categoria }} &middot; {% if item.marcas == 1 %}1 marca{% else %}{{ item.marcas }} marcas{% endif %}
            {% endif %}
          </p>
          {% if not (is_revita or is_ariel or is_fab or is_3d) %}
          <span>Desde {{ item.precio_desde|cop }}</span>
          {% endif %}
        </div>
      </a>
      {% endfor %}
    {% else %}
      <div class="tienda-empty">
        <strong>No encontramos resultados.</strong>
        <p>Prueba con otra palabra o cambia la categoria.</p>
      </div>
    {% endif %}
  </section>

  <div class="tienda-paginacion">
    {% if page > 1 %}
      <a href="/tienda?page={{ page - 1 }}{% if cat %}&cat={{ cat }}{% endif %}{% if q %}&q={{ q|urlencode }}{% endif %}">Anterior</a>
    {% endif %}
    <span>Pagina {{ page }} de {{ pages }}</span>
    {% if page < pages %}
      <a href="/tienda?page={{ page + 1 }}{% if cat %}&cat={{ cat }}{% endif %}{% if q %}&q={{ q|urlencode }}{% endif %}">Siguiente</a>
    {% endif %}
  </div>
  {% endif %}
</main>

<div class="quick-modal" id="quickModal" aria-hidden="true">
  <div class="quick-overlay" data-close></div>
  <div class="quick-sheet" role="dialog" aria-modal="true">
    <button class="quick-close" type="button" data-close aria-label="Cerrar">&times;</button>
    <div class="quick-body">
      <div class="quick-image">
        <img id="quickImg" class="quick-base" src="/static/images/placeholder.svg" alt="Producto" data-fallback="/static/images/placeholder.svg" onerror="this.onerror=null; this.src=this.dataset.fallback || '/static/images/placeholder.svg';">
        <div class="quick-hotspots quick-bags" id="quickHotspots"></div>
      </div>
      <div class="quick-details">
        <span class="quick-tag" id="quickTag"></span>
        <h2 id="quickName"></h2>
        <p id="quickSize"></p>
        <div class="quick-precios">
          <h3>Precio unitario</h3>
          <div class="precio-grid" id="quickPriceList"></div>
        </div>
        <div class="quick-qty">
          <span>Cantidad</span>
          <div class="qty-control quick-qty-control">
            <button type="button" class="qty-btn" data-qty="-">-</button>
            <input type="number" id="quickQty" min="1" value="1">
            <button type="button" class="qty-btn" data-qty="+">+</button>
          </div>
        </div>
        <div class="quick-total">
          <span>Total</span>
          <strong id="quickTotal">$0</strong>
        </div>
        <button class="tienda-btn" id="quickAdd">Agregar al carrito</button>
      </div>
    </div>
  </div>
</div>

<script>
  const themeToggle = document.querySelector(".modo-nocturno");
  const themeIcon = themeToggle ? themeToggle.querySelector("i") : null;
  const setTheme = (isDark) => {
    document.body.classList.toggle("dark", isDark);
    if (themeToggle) themeToggle.classList.toggle("active", isDark);
    if (themeIcon) {
      themeIcon.innerHTML = isDark ? "&#9728;" : "&#9789;";
    }
    localStorage.setItem("tema", isDark ? "dark" : "light");
  };

  const storedTheme = localStorage.getItem("tema");
  if (storedTheme) setTheme(storedTheme === "dark");

  if (themeToggle) {
    themeToggle.addEventListener("click", (e) => {
      e.preventDefault();
      setTheme(!document.body.classList.contains("dark"));
    });
  }

  const CART_KEY = 'du_cart';
  const cartCount = document.getElementById('cartCount');
  const updateCartCount = () => {
    if (!cartCount) return;
    const stored = localStorage.getItem(CART_KEY);
    let total = 0;
    if (stored) {
      try {
        const cart = JSON.parse(stored);
        total = cart.reduce((acc, item) => acc + (Number(item.qty) || 0), 0);
      } catch (e) { total = 0; }
    }
    cartCount.textContent = total;
  };
  updateCartCount();
  window.addEventListener('storage', updateCartCount);

  document.querySelectorAll('.tienda-search').forEach((form) => {
    const cameraBtn = form.querySelector('.tienda-camera');
    const cameraInput = form.querySelector('.tienda-camera-input');
    const clearBtn = form.querySelector('.tienda-clear');
    const input = form.querySelector('.tienda-input');
    if (!cameraBtn || !cameraInput) return;
    const toggleClear = () => {
      if (!input) return;
      form.classList.toggle('has-text', input.value.trim().length > 0);
    };
    cameraBtn.addEventListener('click', (e) => {
      e.preventDefault();
      cameraInput.click();
    });
    cameraInput.addEventListener('change', () => {
      if (cameraInput.files && cameraInput.files.length) {
        alert('Busqueda por foto en desarrollo. Pronto habilitaremos esta funcion.');
        cameraInput.value = '';
      }
    });
    if (clearBtn && input) {
      toggleClear();
      input.addEventListener('input', toggleClear);
      clearBtn.addEventListener('click', () => {
        input.value = '';
        toggleClear();
        input.focus();
      });
    }
  });

  const injectAllProductsInCatalog = () => {
    const activeCat = (chipsWrap?.dataset.activeCat || '').trim().toLowerCase();
    if (activeCat) return;
    const grid = document.querySelector('.tienda-grid');
    if (!grid) return;
    const existingNames = new Set(
      Array.from(grid.querySelectorAll('.tienda-card')).map((card) => (card.dataset.producto || '').toLowerCase().trim())
    );
    const extras = [
      { nombre: 'Axion', imagen: '/static/images/axion.jpg', quickType: 'axion', variantes: [{ presentacion_id: 'axion-900', contenido: '900 g' }] },
      { nombre: 'Lozacrem', imagen: '/static/images/lozacrem.jpg', quickType: 'lozacrem', variantes: [{ presentacion_id: 'lozacrem-720', contenido: '720 ml' }] },
      { nombre: 'Dona Lupe', imagen: '/static/images/do%C3%B1alupe.png', quickType: 'donalupe', variantes: [{ presentacion_id: 'donalupe-900', contenido: '900 g' }] },
      { nombre: 'Supremo Barra', imagen: '/static/images/supremo-ba.png', quickType: 'supremo-barra', variantes: [{ presentacion_id: 'supremo-barra-500', contenido: '500 g' }] },
      { nombre: 'Losa-Crem Liquido', imagen: '/static/images/losa-crem.jpg', quickType: 'losa-crem-liq', variantes: [{ presentacion_id: 'losa-crem-liq-900', contenido: '900 ml' }] },
      { nombre: '3D Liquido', imagen: '/static/images/3d-liquido.jpg', quickType: '3d-liquido', variantes: [{ presentacion_id: '3d-liquido-900', contenido: '900 ml' }] },
      { nombre: 'AK1 Liquido', imagen: '/static/images/ak1.jpg', quickType: 'ak1-liquido', variantes: [{ presentacion_id: 'ak1-liquido-900', contenido: '900 ml' }] },
      { nombre: 'Suavitel Tarro', imagen: '/static/images/suavitel-tarro.png', quickType: 'suavitel-tarro', variantes: [{ presentacion_id: 'suavitel-tarro-frasco', contenido: 'Frasco 1 L' }] },
      { nombre: 'Suavitel Repuesto', imagen: '/static/images/suavitel-sin-t.png', quickType: 'suavitel-sin-t', variantes: [{ presentacion_id: 'suavitel-sin-t-rosas', contenido: 'Rosas 900 ml' }] },
      { nombre: 'Suavitel Repuesto c/Tapa', imagen: '/static/images/suavitel-con-t.png', quickType: 'suavitel-con-t', variantes: [{ presentacion_id: 'suavitel-con-t-rosas', contenido: 'Rosas 900 ml' }] },
      { nombre: 'Limpido 1 L', imagen: '/static/images/limpido.png', quickType: 'limpido', variantes: [{ presentacion_id: 'limpido-1000', contenido: '1 L' }] },
      { nombre: 'Limpido 500 ml', imagen: '/static/images/limpidopeq.png', quickType: 'limpido', variantes: [{ presentacion_id: 'limpido-500', contenido: '500 ml' }] },
      { nombre: 'Barrigón', imagen: '/static/images/barrigon.jpg', quickType: 'barrigon', variantes: [{ presentacion_id: 'barrigon-300', contenido: '300 g' }] },
      { nombre: 'Jabón Coco', imagen: '/static/images/coco.jpg', quickType: 'coco', variantes: [{ presentacion_id: 'coco-300', contenido: '300 g' }] },
      { nombre: 'Jabón Vela Rosa', imagen: '/static/images/vel-rosa.jpg', quickType: 'vel-rosa', variantes: [{ presentacion_id: 'vel-rosa-300', contenido: '300 g' }] }
    ];
    extras.forEach((item) => {
      const keyName = item.nombre.toLowerCase().trim();
      if (existingNames.has(keyName)) return;
      const card = document.createElement('a');
      card.className = 'tienda-card focusable quick-view';
      card.href = '#';
      card.dataset.quickType = item.quickType;
      card.dataset.producto = item.nombre;
      card.dataset.categoria = 'Catalogo';
      card.dataset.variantes = JSON.stringify(item.variantes || []);
      card.innerHTML = `
        <div class="tienda-img">
          <img src="${item.imagen}" alt="${item.nombre}" loading="lazy" decoding="async" onerror="if(document.body.classList.contains('vista-todos')){const card=this.closest('.tienda-card'); if(card) card.remove();} else {this.onerror=null; this.src='/static/images/placeholder.svg';}">
        </div>
        <div class="tienda-info"><h3>${item.nombre}</h3></div>
      `;
      grid.appendChild(card);
      existingNames.add(keyName);
    });
  };

  const setupMobileCategoryRail = () => {
    if (!chipsWrap) return;
    const chipsContainer = document.querySelector('.tienda-chips');
    if (!chipsContainer) return;
    const mq = window.matchMedia('(max-width: 650px)');
    const trigger = chipsWrap.querySelector('.chip-story');
    if (!trigger) return;
    const isTodoTrigger = document.body.classList.contains('vista-todos') && trigger.classList.contains('chip-home');

    let justOpenedByTouch = false;
    const close = () => {
      if (mq.matches) return;
      document.body.classList.remove('chips-open');
    };
    const open = () => document.body.classList.add('chips-open');
    const toggle = () => document.body.classList.toggle('chips-open');
    const enforceFixedOpen = () => {
      if (mq.matches) {
        document.body.classList.add('chips-open');
      } else {
        document.body.classList.remove('chips-open');
      }
    };
    enforceFixedOpen();
    const openFromInteraction = (e) => {
      if (!mq.matches) return;
      e.preventDefault();
      e.stopPropagation();
      open();
    };

    trigger.addEventListener('touchstart', (e) => {
      if (!mq.matches) return;
      if (isTodoTrigger) {
        justOpenedByTouch = true;
        e.preventDefault();
        e.stopPropagation();
        open();
        setTimeout(() => { justOpenedByTouch = false; }, 420);
        return;
      }
      if (document.body.classList.contains('chips-open')) return;
      justOpenedByTouch = true;
      openFromInteraction(e);
      setTimeout(() => { justOpenedByTouch = false; }, 420);
    }, { passive: false });

    trigger.addEventListener('click', (e) => {
      if (!mq.matches) return;
      if (isTodoTrigger) {
        e.preventDefault();
        e.stopPropagation();
        if (justOpenedByTouch) {
          justOpenedByTouch = false;
          return;
        }
        open();
        return;
      }
      if (justOpenedByTouch) {
        e.preventDefault();
        e.stopPropagation();
        return;
      }
      if (!document.body.classList.contains('chips-open')) {
        openFromInteraction(e);
      }
      // Si ya esta abierto, dejamos que el enlace haga su navegacion normal.
    });

    chipsContainer.addEventListener('click', (e) => {
      if (!mq.matches) return;
      const chip = e.target.closest('.chip-story');
      if (!chip || chip === trigger) return;
      close();
    });

    document.addEventListener('click', (e) => {
      if (!mq.matches) return;
      if (!chipsContainer.contains(e.target) && !e.target.closest('.tienda-search-mobile')) close();
    });

    document.addEventListener('touchstart', (e) => {
      if (!mq.matches) return;
      if (!chipsContainer.contains(e.target) && !e.target.closest('.tienda-search-mobile')) close();
    }, { passive: true });

    window.addEventListener('pageshow', enforceFixedOpen);
    window.addEventListener('load', enforceFixedOpen);
    window.addEventListener('resize', enforceFixedOpen, { passive: true });
    window.addEventListener('orientationchange', enforceFixedOpen, { passive: true });
    mq.addEventListener('change', enforceFixedOpen);
  };

  const removeCardsWithoutImageInAll = () => {
    if (!document.body.classList.contains('vista-todos')) return;
    document.querySelectorAll('.tienda-grid .tienda-card img').forEach((img) => {
      const src = (img.getAttribute('src') || '').trim().toLowerCase();
      if (!src || src.includes('placeholder.svg')) {
        const card = img.closest('.tienda-card');
        if (card) card.remove();
      }
    });
  };


  const attachFocusEffects = (container) => {
    if (!container || container.dataset.focusBound === '1') return;
    const focusCards = Array.from(container.querySelectorAll('.tienda-card.focusable'));
    if (!focusCards.length) return;
    container.dataset.focusBound = '1';
    const activate = (card) => {
      container.classList.add('dimmed');
      focusCards.forEach((c) => c.classList.remove('active'));
      card.classList.add('active');
    };
    const clear = () => {
      container.classList.remove('dimmed');
      focusCards.forEach((c) => c.classList.remove('active'));
    };
    focusCards.forEach((card) => {
      card.addEventListener('mouseenter', () => activate(card));
      card.addEventListener('mouseleave', clear);
      card.addEventListener('touchstart', () => activate(card), { passive: true });
      card.addEventListener('touchend', () => setTimeout(clear, 700), { passive: true });
      card.addEventListener('focusin', () => activate(card));
      card.addEventListener('focusout', clear);
    });
    document.addEventListener('click', (e) => {
      if (!container.contains(e.target)) clear();
    });
  };

  injectAllProductsInCatalog();
  setupMobileCategoryRail();
  removeCardsWithoutImageInAll();
  if (window.__buildAseoMobileSections) window.__buildAseoMobileSections();
  attachFocusEffects(document.querySelector('.tienda-grid'));
  document.querySelectorAll('.aseo-mobile-row').forEach((row) => attachFocusEffects(row));

  const quickModal = document.getElementById('quickModal');
  const quickSheet = quickModal ? quickModal.querySelector('.quick-sheet') : null;
  const quickImg = document.getElementById('quickImg');
  const quickHotspots = document.getElementById('quickHotspots');
  const quickTag = document.getElementById('quickTag');
  const quickName = document.getElementById('quickName');
  const quickSize = document.getElementById('quickSize');
  const quickPriceList = document.getElementById('quickPriceList');
  const quickAdd = document.getElementById('quickAdd');
  const quickDetails = document.querySelector('.quick-details');
  const quickQty = document.getElementById('quickQty');
  const quickTotal = document.getElementById('quickTotal');
  const zoomBase = 1.92;
  const liftBase = -8;

  const normalize = (text) => (text || '').toLowerCase().replace(/\\s+/g, '').replace(',', '.');
  const formatCOP = (value) => {
    const num = Number(value) || 0;
    return `$${num.toLocaleString('es-CO')}`.replace(/,/g, '.');
  };
  const getUnitPrice = (precios, qty) => {
    if (!precios || !precios.length) return 0;
    const tiers = [...precios].sort((a, b) => a.min_cantidad - b.min_cantidad);
    let chosen = tiers[0];
    tiers.forEach((tier) => {
      if (qty >= tier.min_cantidad) chosen = tier;
    });
    return Number(chosen.precio) || 0;
  };
  const updateQuickTotal = () => {
    if (!quickQty || !quickTotal) return;
    const qty = Math.max(1, parseInt(quickQty.value || '1', 10) || 1);
    quickQty.value = qty;
    const unit = activePriceTiers.length ? getUnitPrice(activePriceTiers, qty) : 0;
    if (activePriceTiers.length) renderPrices(activePriceTiers, qty);
    quickTotal.textContent = unit ? formatCOP(unit * qty) : '$0';
  };
  const renderPrices = (precios, qty = 1) => {
    quickPriceList.innerHTML = '';
    if (!precios || !precios.length) {
      const empty = document.createElement('div');
      empty.className = 'precio-card';
      empty.textContent = 'Precio disponible pronto';
      quickPriceList.appendChild(empty);
      return;
    }
    const tiers = [...precios].sort((a, b) => a.min_cantidad - b.min_cantidad);
    const chosen = tiers.reduce((acc, tier) => (qty >= tier.min_cantidad ? tier : acc), tiers[0]);
    const main = document.createElement('div');
    main.className = 'price-main';
    main.innerHTML = `<span>Valor unidad</span><strong>${formatCOP(chosen.precio)}</strong>`;
    quickPriceList.appendChild(main);
    const options = tiers.filter((tier) => tier.min_cantidad !== chosen.min_cantidad);
    if (options.length) {
      const wrap = document.createElement('div');
      wrap.className = 'price-options';
      options.forEach((tier) => {
        const chip = document.createElement('span');
        chip.className = 'price-option';
        const label = tier.min_cantidad >= 12 ? '12+' : '6+';
        chip.innerHTML = `<span class="price-label">${label}</span><strong>${formatCOP(tier.precio)}</strong>`;
        wrap.appendChild(chip);
      });
      quickPriceList.appendChild(wrap);
    }
  };

  const arielHotspots = [
    { id: '4kg', label: '4 kg', match: '4kg', img: '/static/images/ariel4.jpg', x: 6, y: 28, w: 28, hit: '6px', hitArea: '8px', scale: 1.4, scaleMobile: 1.8, lift: '-10px', liftMobile: '-12px' },
    { id: '1kg', label: '1 kg', match: '1kg', img: '/static/images/ariel1.jpg', x: 30, y: 28, w: 20, hit: '6px', hitArea: '8px', scale: 2.0, scaleMobile: 2.6 },
    { id: '450g', label: '450 g', match: '450g', img: '/static/images/ariel450.jpg', x: 54, y: 34, w: 20, hit: '8px', hitArea: '10px', scale: 2.0, scaleMobile: 2.6 },
    { id: '225g', label: '225 g', match: '225g', img: '/static/images/ariel225.jpg', x: 74, y: 38, w: 18, hit: '6px', hitArea: '8px', scale: 2.0, scaleMobile: 2.6 },
    { id: '100g', label: '100 g', match: '100g', img: '/static/images/ariel100.jpg', x: 42, y: 56, w: 18, hit: '6px', hitArea: '8px', scale: 1.9, scaleMobile: 2.2, lift: '-8px', liftMobile: '-10px' }
  ];
  const revitaHotspots = [
    { id: '2kg', label: '2 kg', match: '2kg', img: '/static/images/ariel-revita.jpg', x: 8, y: 26, w: 28, hit: '6px', hitArea: '8px', scale: 1.35, scaleMobile: 1.7, lift: '-10px', liftMobile: '-12px' },
    { id: '800g', label: '800 g', match: '800g', img: '/static/images/ariel-revita.jpg', x: 40, y: 32, w: 22, hit: '6px', hitArea: '8px', scale: 1.6, scaleMobile: 2.1 },
    { id: '450g', label: '450 g', match: '450g', img: '/static/images/ariel-revita.jpg', x: 66, y: 36, w: 20, hit: '6px', hitArea: '8px', scale: 1.6, scaleMobile: 2.1 }
  ];
  const threeDHotspots = [
    { id: '2kg', label: '2 kg', match: '2kg', img: '/static/images/3d.jpg', x: 2, y: 14, w: 36, hit: '6px', hitArea: '8px', scale: 1.4, scaleMobile: 1.8, lift: '-10px', liftMobile: '-12px' },
    { id: '1kg', label: '1 kg', match: '1kg', img: '/static/images/3d.jpg', x: 40, y: 18, w: 28, hit: '6px', hitArea: '8px', scale: 1.6, scaleMobile: 2.0 },
    { id: '500g', label: '500 g', match: '500g', img: '/static/images/3d.jpg', x: 70, y: 18, w: 24, hit: '6px', hitArea: '8px', scale: 1.6, scaleMobile: 2.0 },
    { id: '250g', label: '250 g', match: '250g', img: '/static/images/3d.jpg', x: 44, y: 62, w: 22, hit: '6px', hitArea: '8px', scale: 1.8, scaleMobile: 2.3 },
    { id: '125g', label: '125 g', match: '125g', img: '/static/images/3d.jpg', x: 72, y: 66, w: 16, hit: '6px', hitArea: '8px', scale: 1.9, scaleMobile: 2.4, lift: '-8px', liftMobile: '-10px' }
  ];
  const fabHotspots = [
    { id: '3_5kg', label: '3.5 kg', match: '3.5', img: '/static/images/fab.jpg', x: 3, y: 18, w: 30, hit: '6px', hitArea: '8px', scale: 1.35, scaleMobile: 1.7, lift: '-10px', liftMobile: '-12px' },
    { id: '2kg', label: '2 kg', match: '2kg', img: '/static/images/fab.jpg', x: 36, y: 20, w: 24, hit: '6px', hitArea: '8px', scale: 1.55, scaleMobile: 1.9 },
    { id: '800g', label: '800 g', match: '800g', img: '/static/images/fab.jpg', x: 30, y: 62, w: 28, hit: '6px', hitArea: '8px', scale: 1.8, scaleMobile: 2.3 },
    { id: '450g', label: '450 g', match: '450g', img: '/static/images/fab.jpg', x: 65, y: 46, w: 16, hit: '6px', hitArea: '8px', scale: 1.7, scaleMobile: 2.2 },
    { id: '225g', label: '225 g', match: '225g', img: '/static/images/fab.jpg', x: 60, y: 58, w: 14, hit: '6px', hitArea: '8px', scale: 1.7, scaleMobile: 2.2 },
    { id: '100g', label: '100 g', match: '100g', img: '/static/images/fab.jpg', x: 66, y: 70, w: 16, hit: '6px', hitArea: '8px', scale: 1.9, scaleMobile: 2.4, lift: '-8px', liftMobile: '-10px' }
  ];
  const axionHotspots = [
    { id: 'axion-900', label: '900 g', match: '900', img: '/static/images/axion.jpg', x: 34, y: 12, w: 26, hit: '8px', hitArea: '10px', scale: 1.2, scaleMobile: 1.5, lift: '-8px', liftMobile: '-10px' },
    { id: 'axion-450', label: '450 g', match: '450', img: '/static/images/axion.jpg', x: 30, y: 38, w: 24, hit: '8px', hitArea: '10px', scale: 1.35, scaleMobile: 1.7 },
    { id: 'axion-200', label: '200 g', match: '200', img: '/static/images/axion.jpg', x: 28, y: 62, w: 22, hit: '8px', hitArea: '10px', scale: 1.45, scaleMobile: 1.85, lift: '-8px', liftMobile: '-10px' }
  ];
  const lozacremHotspots = [
    { id: 'lozacrem-1500', label: '1.5 L', match: '1.5', img: '/static/images/lozacrem.jpg', x: 38, y: 10, w: 22, hit: '8px', hitArea: '10px', scale: 1.28, scaleMobile: 1.65, lift: '-10px', liftMobile: '-12px' },
    { id: 'lozacrem-720', label: '720 ml', match: '720', img: '/static/images/lozacrem.jpg', x: 37, y: 39, w: 20, hit: '8px', hitArea: '10px', scale: 1.42, scaleMobile: 1.82 },
    { id: 'lozacrem-250', label: '250 g', match: '250', img: '/static/images/lozacrem.jpg', x: 36, y: 65, w: 18, hit: '8px', hitArea: '10px', scale: 1.5, scaleMobile: 1.95, lift: '-8px', liftMobile: '-10px' }
  ];
  const donaLupeHotspots = [
    { id: 'donalupe-900', label: '900 g', match: '900', img: '/static/images/do%C3%B1alupe.png', x: 30, y: 20, w: 34, hit: '8px', hitArea: '10px', scale: 1.5, scaleMobile: 1.95, lift: '-12px', liftMobile: '-14px' }
  ];
  const limpidoHotspots = [
    { id: 'limpido-1000', label: '1 L', match: '1l', img: '/static/images/limpido.png', x: 28, y: 14, w: 36, hit: '8px', hitArea: '10px', scale: 1.4, scaleMobile: 1.85, lift: '-10px', liftMobile: '-12px' },
    { id: 'limpido-500', label: '500 ml', match: '500', img: '/static/images/limpidopeq.png', x: 34, y: 48, w: 30, hit: '8px', hitArea: '10px', scale: 1.55, scaleMobile: 2.0 }
  ];
  const ak1Hotspots = [
    { id: 'ak1polvo-900', label: '900 g', match: '900', img: '/static/images/ak1polvo.jpg', x: 26, y: 16, w: 38, hit: '8px', hitArea: '10px', scale: 1.45, scaleMobile: 1.9, lift: '-10px', liftMobile: '-12px' }
  ];
  const jabonLiquidoHotspots = [
    { id: 'losa-crem-liq-900', label: '900 ml', match: '900', img: '/static/images/losa-crem.jpg', x: 26, y: 16, w: 38, hit: '8px', hitArea: '10px', scale: 1.45, scaleMobile: 1.9, lift: '-10px', liftMobile: '-12px' }
  ];
  const threeDLiquidoHotspots = [
    { id: '3d-liquido-900', label: '900 ml', match: '900', img: '/static/images/3d-liquido.jpg', x: 26, y: 16, w: 38, hit: '8px', hitArea: '10px', scale: 1.45, scaleMobile: 1.9, lift: '-10px', liftMobile: '-12px' }
  ];
  const ak1LiquidoHotspots = [
    { id: 'ak1-liquido-900', label: '900 ml', match: '900', img: '/static/images/ak1.jpg', x: 26, y: 16, w: 38, hit: '8px', hitArea: '10px', scale: 1.45, scaleMobile: 1.9, lift: '-10px', liftMobile: '-12px' }
  ];
  const suavitelTarroHotspots = [
    { id: 'suavitel-tarro-frasco', label: 'Tarro 1 L', match: 'frasco', img: '/static/images/suavitel-tarro.png', x: 16, y: 16, w: 36, hit: '12px', hitArea: '14px', scale: 1.65, scaleMobile: 2.2, lift: '-12px', liftMobile: '-14px' },
    { id: 'suavitel-tarro-rosas', label: 'Bolsa Rosas', match: 'rosas', img: '/static/images/suavitel-tarro.png', x: 52, y: 30, w: 34, hit: '12px', hitArea: '14px', scale: 1.65, scaleMobile: 2.2, lift: '-12px', liftMobile: '-14px' }
  ];
  const suavitelSinTHotspots = [
    { id: 'suavitel-sin-t-rosas', label: 'Rosas', match: 'rosas', img: '/static/images/suavitel-sin-t.png', x: 6, y: 14, w: 22, hit: '12px', hitArea: '14px', scale: 1.72, scaleMobile: 2.25, lift: '-12px', liftMobile: '-14px' },
    { id: 'suavitel-sin-t-lavanda', label: 'Lavanda', match: 'lavanda', img: '/static/images/suavitel-sin-t.png', x: 30, y: 14, w: 22, hit: '12px', hitArea: '14px', scale: 1.72, scaleMobile: 2.25, lift: '-12px', liftMobile: '-14px' },
    { id: 'suavitel-sin-t-primavera', label: 'Primavera', match: 'primavera', img: '/static/images/suavitel-sin-t.png', x: 54, y: 14, w: 22, hit: '12px', hitArea: '14px', scale: 1.72, scaleMobile: 2.25, lift: '-12px', liftMobile: '-14px' },
    { id: 'suavitel-sin-t-brisa', label: 'Brisa', match: 'brisa', img: '/static/images/suavitel-sin-t.png', x: 78, y: 14, w: 18, hit: '12px', hitArea: '14px', scale: 1.72, scaleMobile: 2.25, lift: '-12px', liftMobile: '-14px' }
  ];
  const suavitelConTHotspots = [
    { id: 'suavitel-con-t-rosas', label: 'Rosas', match: 'rosas', img: '/static/images/suavitel-con-t.png', x: 6, y: 14, w: 22, hit: '12px', hitArea: '14px', scale: 1.72, scaleMobile: 2.25, lift: '-12px', liftMobile: '-14px' },
    { id: 'suavitel-con-t-lavanda', label: 'Lavanda', match: 'lavanda', img: '/static/images/suavitel-con-t.png', x: 30, y: 14, w: 22, hit: '12px', hitArea: '14px', scale: 1.72, scaleMobile: 2.25, lift: '-12px', liftMobile: '-14px' },
    { id: 'suavitel-con-t-primavera', label: 'Primavera', match: 'primavera', img: '/static/images/suavitel-con-t.png', x: 54, y: 14, w: 22, hit: '12px', hitArea: '14px', scale: 1.72, scaleMobile: 2.25, lift: '-12px', liftMobile: '-14px' },
    { id: 'suavitel-con-t-brisa', label: 'Brisa', match: 'brisa', img: '/static/images/suavitel-con-t.png', x: 78, y: 14, w: 18, hit: '12px', hitArea: '14px', scale: 1.72, scaleMobile: 2.25, lift: '-12px', liftMobile: '-14px' }
  ];
  const supremoHotspots = [
    { id: 'supremo-barra-500', label: '500 g', match: '500', img: '/static/images/supremo-ba.png', x: 22, y: 18, w: 56, hit: '10px', hitArea: '12px', scale: 1.55, scaleMobile: 2.0, lift: '-10px', liftMobile: '-12px' }
  ];
  const barrigonHotspots = [
    { id: 'barrigon-300', label: '300 g', match: '300', img: '/static/images/barrigon.jpg', x: 22, y: 16, w: 56, hit: '10px', hitArea: '12px', scale: 1.58, scaleMobile: 2.04, lift: '-10px', liftMobile: '-12px' }
  ];
  const cocoHotspots = [
    { id: 'coco-300', label: '300 g', match: '300', img: '/static/images/coco.jpg', x: 22, y: 16, w: 56, hit: '10px', hitArea: '12px', scale: 1.58, scaleMobile: 2.04, lift: '-10px', liftMobile: '-12px' }
  ];
  const velRosaHotspots = [
    { id: 'vel-rosa-300', label: '300 g', match: '300', img: '/static/images/vel-rosa.jpg', x: 22, y: 16, w: 56, hit: '10px', hitArea: '12px', scale: 1.58, scaleMobile: 2.04, lift: '-10px', liftMobile: '-12px' }
  ];

  const buildPriceTiers = (unit) => ([
    { min_cantidad: 1, precio: unit },
    { min_cantidad: 6, precio: Math.max(1, Math.round(unit * 0.95)) },
    { min_cantidad: 12, precio: Math.max(1, Math.round(unit * 0.9)) }
  ]);
  const priceMaps = {
    ariel: {
      '4kg': 46500,
      '1kg': 12240,
      '450g': 5900,
      '225g': 3100,
      '100g': 1500
    },
    revita: {
      '2kg': 25900,
      '800g': 10600,
      '450g': 5800
    },
    '3d': {
      '2kg': 18550,
      '1kg': 9450,
      '500g': 4980,
      '250g': 2800,
      '125g': 1250
    },
    fab: {
      '3_5kg': 25990,
      '2kg': 22050,
      '800g': 14350,
      '450g': 6150,
      '225g': 2800,
      '100g': 1500
    },
    axion: {
      'axion-900': 11200,
      'axion-450': 6400,
      'axion-200': 3600
    },
    lozacrem: {
      'lozacrem-1500': 18200,
      'lozacrem-720': 8200,
      'lozacrem-250': 3150
    },
    donalupe: {
      'donalupe-900': 9200
    },
    limpido: {
      'limpido-1000': 9800,
      'limpido-500': 5700
    },
    ak1polvo: {
      'ak1polvo-900': 4200
    },
    'losa-crem-liq': {
      'losa-crem-liq-900': 7600
    },
    '3d-liquido': {
      '3d-liquido-900': 7500
    },
    'ak1-liquido': {
      'ak1-liquido-900': 6900
    },
    'suavitel-tarro': {
      'suavitel-tarro-frasco': 10900,
      'suavitel-tarro-rosas': 8900
    },
    'suavitel-sin-t': {
      'suavitel-sin-t-rosas': 8400,
      'suavitel-sin-t-lavanda': 8400,
      'suavitel-sin-t-primavera': 8400,
      'suavitel-sin-t-brisa': 8400
    },
    'suavitel-con-t': {
      'suavitel-con-t-rosas': 9200,
      'suavitel-con-t-lavanda': 9200,
      'suavitel-con-t-primavera': 9200,
      'suavitel-con-t-brisa': 9200
    },
    'supremo-barra': {
      'supremo-barra-500': 5200
    },
    'barrigon': {
      'barrigon-300': 3200
    },
    'coco': {
      'coco-300': 3400
    },
    'vel-rosa': {
      'vel-rosa-300': 3300
    }
  };
  const quickConfigs = {
    ariel: {
      name: 'Ariel T. Poder',
      brand: 'Ariel',
      img: '/static/images/ariel.jpg',
      hotspots: arielHotspots,
      priceMap: priceMaps.ariel
    },
    revita: {
      name: 'Ariel Revita Color',
      brand: 'Ariel',
      img: '/static/images/ariel-revita.jpg',
      hotspots: revitaHotspots,
      priceMap: priceMaps.revita
    },
    '3d': {
      name: '3D Multiusos',
      brand: '3D',
      img: '/static/images/3d.jpg',
      hotspots: threeDHotspots,
      priceMap: priceMaps['3d']
    },
    fab: {
      name: 'FAB Lavado Perfecto',
      brand: 'FAB',
      img: '/static/images/fab.jpg',
      hotspots: fabHotspots,
      priceMap: priceMaps.fab
    },
    axion: {
      name: 'Axion Lavaloza',
      brand: 'Axion',
      img: '/static/images/axion.jpg',
      hotspots: axionHotspots,
      priceMap: priceMaps.axion
    },
    lozacrem: {
      name: 'Lozacrem',
      brand: 'Lozacrem',
      img: '/static/images/lozacrem.jpg',
      hotspots: lozacremHotspots,
      priceMap: priceMaps.lozacrem
    },
    donalupe: {
      name: 'Dona Lupe',
      brand: 'Dona Lupe',
      img: '/static/images/do%C3%B1alupe.png',
      hotspots: donaLupeHotspots,
      priceMap: priceMaps.donalupe
    },
    limpido: {
      name: 'Limpido',
      brand: 'Limpido',
      img: '/static/images/limpido.png',
      hotspots: limpidoHotspots,
      priceMap: priceMaps.limpido
    },
    ak1polvo: {
      name: 'AK1 Polvo',
      brand: 'AK1',
      img: '/static/images/ak1polvo.jpg',
      hotspots: ak1Hotspots,
      priceMap: priceMaps.ak1polvo
    },
    'losa-crem-liq': {
      name: 'Losa-Crem Liquido',
      brand: 'Losa-Crem',
      img: '/static/images/losa-crem.jpg',
      hotspots: jabonLiquidoHotspots,
      priceMap: priceMaps['losa-crem-liq']
    },
    '3d-liquido': {
      name: '3D Liquido',
      brand: '3D',
      img: '/static/images/3d-liquido.jpg',
      hotspots: threeDLiquidoHotspots,
      priceMap: priceMaps['3d-liquido']
    },
    'ak1-liquido': {
      name: 'AK1 Liquido',
      brand: 'AK1',
      img: '/static/images/ak1.jpg',
      hotspots: ak1LiquidoHotspots,
      priceMap: priceMaps['ak1-liquido']
    },
    'suavitel-tarro': {
      name: 'Suavitel Tarro',
      brand: 'Suavitel',
      img: '/static/images/suavitel-tarro.png',
      hotspots: suavitelTarroHotspots,
      priceMap: priceMaps['suavitel-tarro']
    },
    'suavitel-sin-t': {
      name: 'Suavitel Repuesto',
      brand: 'Suavitel',
      img: '/static/images/suavitel-sin-t.png',
      hotspots: suavitelSinTHotspots,
      priceMap: priceMaps['suavitel-sin-t']
    },
    'suavitel-con-t': {
      name: 'Suavitel Repuesto c/Tapa',
      brand: 'Suavitel',
      img: '/static/images/suavitel-con-t.png',
      hotspots: suavitelConTHotspots,
      priceMap: priceMaps['suavitel-con-t']
    },
    'supremo-barra': {
      name: 'Supremo Barra',
      brand: 'Supremo',
      img: '/static/images/supremo-ba.png',
      hotspots: supremoHotspots,
      priceMap: priceMaps['supremo-barra']
    },
    'barrigon': {
      name: 'Jabón Barrigón',
      brand: 'Barrigón',
      img: '/static/images/barrigon.jpg',
      hotspots: barrigonHotspots,
      priceMap: priceMaps.barrigon
    },
    'coco': {
      name: 'Jabón Coco',
      brand: 'Coco',
      img: '/static/images/coco.jpg',
      hotspots: cocoHotspots,
      priceMap: priceMaps.coco
    },
    'vel-rosa': {
      name: 'Jabón Vela Rosa',
      brand: 'Vela Rosa',
      img: '/static/images/vel-rosa.jpg',
      hotspots: velRosaHotspots,
      priceMap: priceMaps['vel-rosa']
    }
  };

  let activeVariant = null;
  let currentVariants = [];
  let activePriceTiers = [];
  let bagAutoTimer = null;
  let currentQuick = quickConfigs.ariel;
  let currentQuickType = 'ariel';
  const scheduleBagHide = () => {
    if (!quickHotspots) return;
    if (bagAutoTimer) clearTimeout(bagAutoTimer);
    bagAutoTimer = setTimeout(() => {
      quickHotspots.classList.remove('dimmed');
      quickHotspots.querySelectorAll('.bag-item').forEach((el) => el.classList.remove('active'));
    }, 900);
  };
  const selectHotspot = (hotspot, variants) => {
    if (quickHotspots) {
      quickHotspots.classList.add('dimmed');
      quickHotspots.querySelectorAll('.bag-item').forEach((el) => {
        el.classList.toggle('active', el.dataset.id === hotspot.id);
      });
    }
    const match = normalize(hotspot.match);
    activeVariant = variants.find((v) => normalize(v.contenido).includes(match)) || null;
    const quickNameBase = currentQuick ? currentQuick.name : 'Producto';
    if (quickName) quickName.textContent = `${quickNameBase} ${hotspot.label}`;
    if (quickTag) quickTag.textContent = '';
    if (quickSize) quickSize.textContent = '';
    const manualUnit = currentQuick && currentQuick.priceMap ? currentQuick.priceMap[hotspot.id] : null;
    if (!activeVariant && manualUnit) {
      activeVariant = {
        presentacion_id: `${currentQuickType}-${hotspot.id}`,
        marca: currentQuick && currentQuick.brand ? currentQuick.brand : (currentQuick ? currentQuick.name : 'Producto'),
        presentacion: currentQuick ? currentQuick.name : 'Producto',
        contenido: hotspot.label,
        imagen: currentQuick ? currentQuick.img : '/static/images/placeholder.svg'
      };
    }
    activePriceTiers = manualUnit ? buildPriceTiers(manualUnit) : (activeVariant ? (activeVariant.precios || []) : []);
    renderPrices(activePriceTiers, 1);
    if (quickAdd) {
      quickAdd.disabled = !activeVariant;
      quickAdd.textContent = 'Agregar al carrito';
    }
    if (quickDetails) quickDetails.classList.add('show');
    if (quickQty) quickQty.value = 1;
    updateQuickTotal();
    scheduleBagHide();
    const quickImageWrap = quickImg.closest('.quick-image');
    if (quickImageWrap) {
      quickImageWrap.classList.add('focused');
    }
  };

  const openQuick = (card) => {
    if (!quickModal) return;
    let variants = [];
    try {
      variants = JSON.parse(card.dataset.variantes || '[]');
    } catch (e) {
      variants = [];
    }
    currentQuickType = card.dataset.quickType || 'ariel';
    currentQuick = quickConfigs[currentQuickType] || quickConfigs.ariel;
    quickImg.dataset.fallback = '/static/images/placeholder.svg';
    quickImg.src = currentQuick.img;
    if (quickTag) quickTag.textContent = '';
    if (quickName) quickName.textContent = '';
    if (quickSize) quickSize.textContent = '';
    if (quickPriceList) quickPriceList.innerHTML = '';
    if (quickAdd) {
      quickAdd.disabled = true;
      quickAdd.textContent = 'Agregar al carrito';
    }
    if (quickDetails) quickDetails.classList.remove('show');
    activePriceTiers = [];
    if (quickQty) quickQty.value = 1;
    if (quickTotal) quickTotal.textContent = '$0';
    if (quickHotspots) {
      quickHotspots.innerHTML = '';
      quickHotspots.classList.remove('dimmed');
      currentVariants = variants;
      currentQuick.hotspots.forEach((spot) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'bag-item';
        btn.dataset.id = spot.id;
        btn.style.left = `${spot.x}%`;
        btn.style.top = `${spot.y}%`;
        btn.style.width = `${spot.w}%`;
        if (spot.hit) btn.style.setProperty('--hit', spot.hit);
        if (spot.hitArea) btn.style.setProperty('--hit-area', spot.hitArea);
        if (spot.scale) btn.style.setProperty('--scale', spot.scale);
        if (spot.scaleMobile) btn.style.setProperty('--scale-mobile', spot.scaleMobile);
        if (spot.lift) btn.style.setProperty('--lift', spot.lift);
        if (spot.liftMobile) btn.style.setProperty('--lift-mobile', spot.liftMobile);
        btn.innerHTML = `<img src="${spot.img}" alt="${spot.label}">`;
        btn.addEventListener('click', () => selectHotspot(spot, variants));
        btn.addEventListener('touchstart', (e) => {
          e.preventDefault();
          selectHotspot(spot, variants);
        }, { passive: false });
        quickHotspots.appendChild(btn);
      });
    }

    if (currentQuick.hotspots.length === 1) {
      selectHotspot(currentQuick.hotspots[0], variants);
    }

    document.body.classList.add('modal-open');
    quickModal.classList.add('open');
    quickModal.setAttribute('aria-hidden', 'false');
  };

  const closeQuick = () => {
    if (!quickModal) return;
    quickModal.classList.remove('open');
    quickModal.setAttribute('aria-hidden', 'true');
    document.body.classList.remove('modal-open');
    quickImg.style.transform = '';
    const quickImageWrap = quickImg.closest('.quick-image');
    if (quickImageWrap) quickImageWrap.classList.remove('focused');
    if (quickDetails) quickDetails.classList.remove('show');
    if (quickPriceList) quickPriceList.innerHTML = '';
    if (quickAdd) {
      quickAdd.disabled = true;
      quickAdd.textContent = 'Selecciona una bolsa';
    }
    if (quickTag) quickTag.textContent = '';
    if (quickName) quickName.textContent = '';
    if (quickSize) quickSize.textContent = '';
    if (quickQty) quickQty.value = 1;
    if (quickTotal) quickTotal.textContent = '$0';
    if (bagAutoTimer) {
      clearTimeout(bagAutoTimer);
      bagAutoTimer = null;
    }
  };

  document.querySelectorAll('.tienda-card.quick-view').forEach((card) => {
    let touchMeta = null;
    card.addEventListener('click', (e) => {
      const openedByTouchAt = Number(card.dataset.touchOpenAt || 0);
      if (openedByTouchAt && (Date.now() - openedByTouchAt) < 700) {
        e.preventDefault();
        return;
      }
      e.preventDefault();
      openQuick(card);
    });
    card.addEventListener('touchstart', (e) => {
      const touch = e.changedTouches && e.changedTouches[0];
      if (!touch) return;
      touchMeta = {
        x: touch.clientX,
        y: touch.clientY,
        t: Date.now(),
        sy: window.scrollY || window.pageYOffset || 0,
        moved: false
      };
    }, { passive: true });
    card.addEventListener('touchmove', (e) => {
      if (!touchMeta) return;
      const touch = e.changedTouches && e.changedTouches[0];
      if (!touch) return;
      const dx = Math.abs(touch.clientX - touchMeta.x);
      const dy = Math.abs(touch.clientY - touchMeta.y);
      const sy = window.scrollY || window.pageYOffset || 0;
      if (dx > 6 || dy > 6 || Math.abs(sy - touchMeta.sy) > 6) {
        touchMeta.moved = true;
      }
    }, { passive: true });
    card.addEventListener('touchend', (e) => {
      if (!touchMeta) return;
      const touch = e.changedTouches && e.changedTouches[0];
      if (!touch) return;
      const dx = Math.abs(touch.clientX - touchMeta.x);
      const dy = Math.abs(touch.clientY - touchMeta.y);
      const dt = Date.now() - touchMeta.t;
      const sy = window.scrollY || window.pageYOffset || 0;
      const moved = touchMeta.moved || Math.abs(sy - touchMeta.sy) > 6;
      touchMeta = null;
      // Prevent accidental open while vertical scrolling.
      if (moved || dx > 6 || dy > 6 || dt > 320) return;
      e.preventDefault();
      card.dataset.touchOpenAt = String(Date.now());
      openQuick(card);
    }, { passive: false });
    card.addEventListener('touchcancel', () => { touchMeta = null; }, { passive: true });
  });

  if (quickModal) {
    quickModal.querySelectorAll('[data-close]').forEach((el) => {
      el.addEventListener('click', closeQuick);
    });
    quickModal.addEventListener('click', (e) => {
      if (!e.target.closest('.quick-body')) closeQuick();
    });
  }
  const quickImageWrap = quickImg ? quickImg.closest('.quick-image') : null;
  const tryPickNearest = (clientX, clientY) => {
    if (!quickImageWrap || !quickModal || !quickModal.classList.contains('open')) return;
    const rect = quickImageWrap.getBoundingClientRect();
    const x = clientX - rect.left;
    const y = clientY - rect.top;
    let best = null;
    let bestDist = Infinity;
    const spots = currentQuick ? currentQuick.hotspots : arielHotspots;
    spots.forEach((spot) => {
      const cx = rect.width * (spot.x + spot.w / 2) / 100;
      const cy = rect.height * (spot.y + spot.w / 2) / 100;
      const dist = Math.hypot(cx - x, cy - y);
      if (dist < bestDist) {
        bestDist = dist;
        best = spot;
      }
    });
    const limit = window.innerWidth <= 768 ? 110 : 180;
    if (best && bestDist <= limit) selectHotspot(best, currentVariants);
  };
  if (quickImageWrap) {
    let touchPick = null;
    quickImageWrap.addEventListener('click', (e) => {
      if (e.target.closest('.bag-item')) return;
      tryPickNearest(e.clientX, e.clientY);
    });
    quickImageWrap.addEventListener('touchstart', (e) => {
      if (e.target.closest('.bag-item')) return;
      const touch = e.touches && e.touches[0];
      if (!touch) return;
      touchPick = { x: touch.clientX, y: touch.clientY };
    }, { passive: true });
    quickImageWrap.addEventListener('touchend', (e) => {
      if (e.target.closest('.bag-item')) return;
      if (!touchPick) return;
      const touch = e.changedTouches && e.changedTouches[0];
      if (!touch) return;
      const dx = Math.abs(touch.clientX - touchPick.x);
      const dy = Math.abs(touch.clientY - touchPick.y);
      touchPick = null;
      if (dx > 10 || dy > 10) return;
      e.preventDefault();
      tryPickNearest(touch.clientX, touch.clientY);
    }, { passive: false });
  }
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeQuick();
  });

  if (quickAdd) {
    quickAdd.addEventListener('click', () => {
      if (!activeVariant) return;
      const qty = quickQty ? Math.max(1, parseInt(quickQty.value || '1', 10) || 1) : 1;
      const unit = activePriceTiers.length ? getUnitPrice(activePriceTiers, qty) : 0;
      const item = {
        id: activeVariant.presentacion_id,
        producto: currentQuick ? currentQuick.name : 'Producto',
        marca: activeVariant.marca || 'Ariel',
        presentacion: activeVariant.presentacion,
          contenido: activeVariant.contenido,
        imagen: activeVariant.imagen,
        qty,
        unit
      };
      const stored = localStorage.getItem(CART_KEY);
      let cart = [];
      if (stored) {
        try { cart = JSON.parse(stored); } catch (e) { cart = []; }
      }
      const idx = cart.findIndex((c) => c.id === item.id);
      if (idx >= 0) {
        cart[idx].qty += item.qty;
      } else {
        cart.push(item);
      }
      localStorage.setItem(CART_KEY, JSON.stringify(cart));
      quickAdd.textContent = 'Agregado';
      updateCartCount();
      setTimeout(() => { quickAdd.textContent = 'Agregar al carrito'; }, 1400);
    });
  }

  if (quickQty) {
    quickQty.addEventListener('input', () => {
      const value = Math.max(1, parseInt(quickQty.value || '1', 10) || 1);
      quickQty.value = value;
      updateQuickTotal();
      scheduleBagHide();
    });
  }
  document.querySelectorAll('.quick-qty-control .qty-btn').forEach((btn) => {
    btn.addEventListener('click', () => {
      if (!quickQty) return;
      const delta = btn.dataset.qty === '+' ? 1 : -1;
      const value = Math.max(1, parseInt(quickQty.value || '1', 10) + delta);
      quickQty.value = value;
      updateQuickTotal();
      scheduleBagHide();
    });
  });

</script>

</body>
</html>

