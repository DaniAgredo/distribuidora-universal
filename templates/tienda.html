<!DOCTYPE html>
<html lang="es">
<head>
<link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tienda - Distribuidora Universal</title>

<link rel="stylesheet" href="/static/style.css">
<link rel="stylesheet" href="/static/tienda.css">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>

<body class="pagina-tienda">

<header class="header">
  <div class="fila-superior tienda-header">
    <div class="tienda-left">
      <div class="titulo tienda-title">
        <span class="icono">&#127758;</span>
        <div class="nombre">
          Tienda Universal
          
        </div>
      </div>
      <form class="tienda-search tienda-search-mobile" method="get" action="/tienda">
        <input type="hidden" name="cat" value="{{ cat }}">
        <button class="tienda-btn" type="submit">Buscar</button>
        <button class="tienda-lupa" type="submit" aria-label="Buscar">
          <i class="fa-solid fa-magnifying-glass"></i>
        </button>
        <input class="tienda-input" type="text" name="q" value="{{ q }}" placeholder="Buscar productos, marcas o categorias...">
        <button class="tienda-clear" type="button" aria-label="Borrar">
          <i class="fa-solid fa-xmark"></i>
        </button>
        <button class="tienda-camera" type="button" aria-label="Buscar con camara">
          <i class="fa-solid fa-camera"></i>
        </button>
        <input class="tienda-camera-input" type="file" accept="image/*" capture="environment">
      </form>
    </div>
    <div class="acciones tienda-acciones">
      <a href="https://wa.me/573215485315" class="whatsapp" target="_blank" rel="noopener">
        <i class="fa-brands fa-whatsapp"></i>
        <span class="whatsapp-saludo">WhatsApp</span>
      </a>
      <a href="/" class="volver volver-circle" aria-label="Volver">&#8592;</a>
      <a href="/carrito" class="carrito-link"><i class="fa-solid fa-bag-shopping"></i> Carrito <span id="cartCount">0</span></a>
      <a href="/cuenta" class="login"><i class="fa-solid fa-user login-icon"></i> <span class="login-text">Cuenta</span></a>
      <a href="#" class="modo-nocturno" aria-label="Modo nocturno">
        <i class="fa-solid fa-moon"></i>
      </a>
    </div>
  </div>
</header>

<main class="tienda-main">
  {% set cat_images = [
    '/static/images/banner1.jpg',
    '/static/images/banner2.jpg',
    '/static/images/banner3.jpg',
    '/static/images/banner4.jpg',
    '/static/images/banner5.jpg',
    '/static/images/banner6.jpg',
    '/static/images/banner7.jpg',
    '/static/images/banner8.jpg'
  ] %}
  {% set cat_labels = {
    'comestibles': 'Abarrotes',
    'cuidado-adulto': 'Cuidado adulto',
    'insecticidas': 'Insecticidas y venenos',
    'juegos': 'Juegos'
  } %}
  <section class="tienda-chips" aria-label="Categorias">
    <div class="chips-story" data-active-cat="{{ cat }}" data-current-q="{{ q }}">
      <a class="chip-story {% if not cat %}active{% endif %}" data-cat="" href="/tienda{% if q %}?q={{ q|urlencode }}{% endif %}">
        <span class="chip-circle">
          <img src="/static/images/banner1.jpg" alt="Todos" loading="lazy">
        </span>
        <span class="chip-name">Todos</span>
      </a>
      {% if categorias %}
        {% set existing = categorias|map(attribute='slug')|list %}
        {% for c in categorias %}
        {% set nombre_categoria = cat_labels.get(c.slug, c.nombre) %}
        <a class="chip-story {% if cat == c.slug %}active{% endif %}" data-cat="{{ c.slug }}" href="/tienda?cat={{ c.slug }}{% if q %}&q={{ q|urlencode }}{% endif %}">
          <span class="chip-circle">
            <img src="{{ cat_images[loop.index0 % cat_images|length] }}" alt="{{ nombre_categoria }}" loading="lazy">
          </span>
          <span class="chip-name">{{ nombre_categoria }}</span>
        </a>
        {% endfor %}
        {% if 'juegos' not in existing %}
        <a class="chip-story {% if cat == 'juegos' %}active{% endif %}" data-cat="juegos" href="/tienda?cat=juegos{% if q %}&q={{ q|urlencode }}{% endif %}">
          <span class="chip-circle">
            <img src="{{ cat_images[0] }}" alt="Juegos" loading="lazy">
          </span>
          <span class="chip-name">Juegos</span>
        </a>
        {% endif %}
        {% if 'cuidado-adulto' not in existing %}
        <a class="chip-story {% if cat == 'cuidado-adulto' %}active{% endif %}" data-cat="cuidado-adulto" href="/tienda?cat=cuidado-adulto{% if q %}&q={{ q|urlencode }}{% endif %}">
          <span class="chip-circle">
            <img src="{{ cat_images[1] }}" alt="Cuidado adulto" loading="lazy">
          </span>
          <span class="chip-name">Cuidado adulto</span>
        </a>
        {% endif %}
        {% if 'insecticidas' not in existing %}
        <a class="chip-story {% if cat == 'insecticidas' %}active{% endif %}" data-cat="insecticidas" href="/tienda?cat=insecticidas{% if q %}&q={{ q|urlencode }}{% endif %}">
          <span class="chip-circle">
            <img src="{{ cat_images[2] }}" alt="Insecticidas y venenos" loading="lazy">
          </span>
          <span class="chip-name">Insecticidas y venenos</span>
        </a>
        {% endif %}
      {% else %}
        {% set fallback = [
          ('aseo','Aseo'),
          ('drogueria','Droguer&iacute;a'),
          ('ferreteria','Ferreter&iacute;a'),
          ('papeleria','Papeler&iacute;a'),
          ('cuidado-bebes','Cuidado beb&eacute;s'),
          ('cuidado-adulto','Cuidado adulto'),
          ('abarrotes','Abarrotes'),
          ('juegos','Juegos'),
          ('insecticidas','Insecticidas y venenos'),
          ('varios','Varios')
        ] %}
        {% for slug, nombre in fallback %}
        <a class="chip-story {% if cat == slug %}active{% endif %}" data-cat="{{ slug }}" href="/tienda?cat={{ slug }}{% if q %}&q={{ q|urlencode }}{% endif %}">
          <span class="chip-circle">
            <img src="{{ cat_images[loop.index0 % cat_images|length] }}" alt="{{ nombre }}" loading="lazy">
          </span>
          <span class="chip-name">{{ nombre }}</span>
        </a>
        {% endfor %}
      {% endif %}
    </div>
    <div class="tienda-resumen">
      {% if not db_missing %}
        <span>{{ total }} articulos</span>
      {% endif %}
    </div>
  </section>
  <script>
    const chipsWrap = document.querySelector('.chips-story');
    if (chipsWrap) {
      const updateFocus = () => {
        const rect = chipsWrap.getBoundingClientRect();
        const center = rect.left + rect.width / 2;
        let best = null;
        let bestDist = Infinity;
        chipsWrap.querySelectorAll('.chip-story').forEach((chip) => {
          const cRect = chip.getBoundingClientRect();
          const cCenter = cRect.left + cRect.width / 2;
          const dist = Math.abs(center - cCenter);
          if (dist < bestDist) {
            bestDist = dist;
            best = chip;
          }
        });
        chipsWrap.querySelectorAll('.chip-story.is-focus').forEach((el) => el.classList.remove('is-focus'));
        if (best) best.classList.add('is-focus');
      };
      chipsWrap.addEventListener('scroll', () => {
        window.requestAnimationFrame(updateFocus);
      });
      chipsWrap.addEventListener('touchstart', updateFocus, { passive: true });
      window.addEventListener('resize', updateFocus);
      updateFocus();
    }

    const subcatImages = [
      '/static/images/banner1.jpg',
      '/static/images/banner2.jpg',
      '/static/images/banner3.jpg',
      '/static/images/banner4.jpg',
      '/static/images/banner5.jpg',
      '/static/images/banner6.jpg',
      '/static/images/banner7.jpg',
      '/static/images/banner8.jpg'
    ];
    const subcatsMap = {
      'aseo': [
        { label: 'Detergentes', q: 'detergente', img: '/static/images/banner1.jpg' },
        { label: 'Lava loza', q: 'lava loza', img: '/static/images/banner2.jpg' },
        { label: 'Limpieza pisos', q: 'limpieza', img: '/static/images/banner3.jpg' },
        { label: 'Aromas', q: 'aroma', img: '/static/images/banner4.jpg' },
        { label: 'Suavizantes', q: 'suavizante', img: '/static/images/banner5.jpg' }
      ],
      'drogueria': [
        { label: 'Tabletas', q: 'tabletas', img: '/static/images/banner6.jpg' },
        { label: 'Jarabes', q: 'jarabe', img: '/static/images/banner7.jpg' },
        { label: 'Vitaminas', q: 'vitamina', img: '/static/images/banner8.jpg' },
        { label: 'Termometros', q: 'termometro', img: '/static/images/banner9.jpg' },
        { label: 'Curacion', q: 'curacion', img: '/static/images/banner10.jpg' }
      ],
      'cuidado-bebes': [
        { label: 'Panales', q: 'panal', img: '/static/images/banner11.jpg' },
        { label: 'Toallitas', q: 'toallitas', img: '/static/images/banner12.jpg' },
        { label: 'Cremas', q: 'crema', img: '/static/images/banner13.jpg' }
      ],
      'cuidado-adulto': [
        { label: 'Panales', q: 'panal', img: '/static/images/banner14.jpg' },
        { label: 'Protectores', q: 'protector', img: '/static/images/banner15.jpg' },
        { label: 'Humedas', q: 'toallitas', img: '/static/images/banner16.jpg' }
      ]
    };

    if (chipsWrap) {
      const activeCat = chipsWrap.dataset.activeCat || '';
      const currentQ = chipsWrap.dataset.currentQ || '';
      const list = subcatsMap[activeCat];
      if (activeCat && list && list.length) {
        chipsWrap.classList.add('subcats-only');
        chipsWrap.innerHTML = '';
        const volver = document.createElement('a');
        volver.className = 'chip-story chip-volver';
        volver.href = currentQ ? `/tienda?q=${encodeURIComponent(currentQ)}` : '/tienda';
        volver.innerHTML = '<span class="chip-circle"><img src="/static/images/banner9.jpg" alt="Volver"></span><span class="chip-name">Categorias</span>';
        chipsWrap.appendChild(volver);
        list.forEach((item, idx) => {
          const img = item.img || subcatImages[idx % subcatImages.length];
          const a = document.createElement('a');
          a.className = 'chip-story subcat';
          a.href = `/tienda?cat=${encodeURIComponent(activeCat)}&q=${encodeURIComponent(item.q)}`;
          a.innerHTML = `<span class="chip-circle"><img src="${img}" alt="${item.label}"></span><span class="chip-name">${item.label}</span>`;
          chipsWrap.appendChild(a);
        });
      }
    }
  </script>

  {% if db_missing %}
  <div class="tienda-empty">
    <strong>Base de datos no encontrada.</strong>
    <p>Ejecuta el script para crear el catalogo.</p>
  </div>
  {% endif %}

  {% if not db_missing %}
  <section class="tienda-grid" aria-label="Listado de productos">
    {% set added_revita = false %}
    {% set added_fab = false %}
    {% set added_3d = false %}
    {% if items %}
      {% for item in items %}
      {% set producto_nombre = (item.producto or '')|lower %}
      {% set producto_categoria = (item.categoria or '')|lower %}
      {% set producto_imagen = item.imagen or '/static/images/placeholder.svg' %}
      {% set is_ariel = 'ariel' in producto_nombre %}
      {% set is_revita = 'revita' in producto_nombre or 'revitacolor' in producto_nombre %}
      {% set is_fab = 'fab' in producto_nombre and 'fabuloso' not in producto_nombre %}
      {% set is_3d = '3d' in producto_nombre %}
      {% if is_revita %}
        {% set producto_imagen = '/static/images/ariel100.jpg' %}
        {% set added_revita = true %}
      {% elif is_fab %}
        {% set producto_imagen = '/static/images/fab-thumb.jpg' %}
        {% set added_fab = true %}
      {% elif is_3d %}
        {% set producto_imagen = '/static/images/3d-thumb.jpg' %}
        {% set added_3d = true %}
      {% elif is_ariel %}
        {% set producto_imagen = '/static/images/ariel100.jpg' %}
      {% endif %}
      {% set producto_variantes = variants_by_product.get(item.producto_id, []) %}
      {% set is_quick = is_ariel or is_revita or is_fab or is_3d %}
      <a class="tienda-card {% if is_quick %}focusable quick-view{% endif %}"
         href="/producto/{{ item.producto_id }}"
         data-producto="{{ item.producto }}"
         data-categoria="{{ item.categoria }}"
         {% if is_quick %}data-quick-type="{% if is_revita %}revita{% elif is_fab %}fab{% elif is_3d %}3d{% elif is_ariel %}ariel{% endif %}"{% endif %}
         {% if is_quick %}data-variantes='{{ producto_variantes|tojson }}'{% endif %}>
        <div class="tienda-img">
          <img src="{{ producto_imagen }}" alt="{{ item.producto }}" loading="lazy" decoding="async" fetchpriority="low" width="640" height="420" onerror="this.onerror=null; this.src='/static/images/placeholder.svg';">
        </div>
      <div class="tienda-info">
          <h3>
            {% if is_revita %}Ariel Revita Color
            {% elif is_fab %}Fab Lavado Perfecto
            {% elif is_3d %}3D Multiusos
            {% elif is_ariel %}Ariel Triple Poder
            {% else %}{{ item.producto }}
            {% endif %}
          </h3>
          <p>
            {% if is_revita or is_ariel or is_fab or is_3d %}
            {% else %}
              {{ item.categoria }} &middot; {% if item.marcas == 1 %}1 marca{% else %}{{ item.marcas }} marcas{% endif %}
            {% endif %}
          </p>
          {% if not (is_revita or is_ariel or is_fab or is_3d) %}
          <span>Desde {{ item.precio_desde|cop }}</span>
          {% endif %}
        </div>
      </a>
      {% endfor %}
    {% else %}
      <div class="tienda-empty">
        <strong>No encontramos resultados.</strong>
        <p>Prueba con otra palabra o cambia la categoria.</p>
      </div>
    {% endif %}
  </section>

  <div class="tienda-paginacion">
    {% if page > 1 %}
      <a href="/tienda?page={{ page - 1 }}{% if cat %}&cat={{ cat }}{% endif %}{% if q %}&q={{ q|urlencode }}{% endif %}">Anterior</a>
    {% endif %}
    <span>Pagina {{ page }} de {{ pages }}</span>
    {% if page < pages %}
      <a href="/tienda?page={{ page + 1 }}{% if cat %}&cat={{ cat }}{% endif %}{% if q %}&q={{ q|urlencode }}{% endif %}">Siguiente</a>
    {% endif %}
  </div>
  {% endif %}
</main>

<div class="quick-modal" id="quickModal" aria-hidden="true">
  <div class="quick-overlay" data-close></div>
  <div class="quick-sheet" role="dialog" aria-modal="true">
    <button class="quick-close" type="button" data-close aria-label="Cerrar">&times;</button>
    <div class="quick-body">
      <div class="quick-image">
        <img id="quickImg" class="quick-base" src="/static/images/placeholder.svg" alt="Producto" data-fallback="/static/images/placeholder.svg" onerror="this.onerror=null; this.src=this.dataset.fallback || '/static/images/placeholder.svg';">
        <div class="quick-hotspots quick-bags" id="quickHotspots"></div>
      </div>
      <div class="quick-details">
        <span class="quick-tag" id="quickTag"></span>
        <h2 id="quickName"></h2>
        <p id="quickSize"></p>
        <div class="quick-precios">
          <h3>Precio unitario</h3>
          <div class="precio-grid" id="quickPriceList"></div>
        </div>
        <div class="quick-qty">
          <span>Cantidad</span>
          <div class="qty-control quick-qty-control">
            <button type="button" class="qty-btn" data-qty="-">-</button>
            <input type="number" id="quickQty" min="1" value="1">
            <button type="button" class="qty-btn" data-qty="+">+</button>
          </div>
        </div>
        <div class="quick-total">
          <span>Total</span>
          <strong id="quickTotal">$0</strong>
        </div>
        <button class="tienda-btn" id="quickAdd">Agregar al carrito</button>
      </div>
    </div>
  </div>
</div>

<script>
  const themeToggle = document.querySelector(".modo-nocturno");
  const themeIcon = themeToggle ? themeToggle.querySelector("i") : null;
  const setTheme = (isDark) => {
    document.body.classList.toggle("dark", isDark);
    if (themeToggle) themeToggle.classList.toggle("active", isDark);
    if (themeIcon) {
      themeIcon.classList.toggle("fa-moon", !isDark);
      themeIcon.classList.toggle("fa-sun", isDark);
      themeIcon.classList.toggle("fa-solid", !isDark);
      themeIcon.classList.toggle("fa-regular", isDark);
    }
    localStorage.setItem("tema", isDark ? "dark" : "light");
  };

  const storedTheme = localStorage.getItem("tema");
  if (storedTheme) setTheme(storedTheme === "dark");

  if (themeToggle) {
    themeToggle.addEventListener("click", (e) => {
      e.preventDefault();
      setTheme(!document.body.classList.contains("dark"));
    });
  }

  const CART_KEY = 'du_cart';
  const cartCount = document.getElementById('cartCount');
  const updateCartCount = () => {
    if (!cartCount) return;
    const stored = localStorage.getItem(CART_KEY);
    let total = 0;
    if (stored) {
      try {
        const cart = JSON.parse(stored);
        total = cart.reduce((acc, item) => acc + (Number(item.qty) || 0), 0);
      } catch (e) { total = 0; }
    }
    cartCount.textContent = total;
  };
  updateCartCount();
  window.addEventListener('storage', updateCartCount);

  document.querySelectorAll('.tienda-search').forEach((form) => {
    const cameraBtn = form.querySelector('.tienda-camera');
    const cameraInput = form.querySelector('.tienda-camera-input');
    const clearBtn = form.querySelector('.tienda-clear');
    const input = form.querySelector('.tienda-input');
    if (!cameraBtn || !cameraInput) return;
    const toggleClear = () => {
      if (!input) return;
      form.classList.toggle('has-text', input.value.trim().length > 0);
    };
    cameraBtn.addEventListener('click', (e) => {
      e.preventDefault();
      cameraInput.click();
    });
    cameraInput.addEventListener('change', () => {
      if (cameraInput.files && cameraInput.files.length) {
        alert('Busqueda por foto en desarrollo. Pronto habilitaremos esta funcion.');
        cameraInput.value = '';
      }
    });
    if (clearBtn && input) {
      toggleClear();
      input.addEventListener('input', toggleClear);
      clearBtn.addEventListener('click', () => {
        input.value = '';
        toggleClear();
        input.focus();
      });
    }
  });

  const grid = document.querySelector('.tienda-grid');
  if (grid) {
    const focusCards = Array.from(grid.querySelectorAll('.tienda-card.focusable'));
    const activate = (card) => {
      grid.classList.add('dimmed');
      focusCards.forEach((c) => c.classList.remove('active'));
      card.classList.add('active');
    };
    const clear = () => {
      grid.classList.remove('dimmed');
      focusCards.forEach((c) => c.classList.remove('active'));
    };
    focusCards.forEach((card) => {
      card.addEventListener('mouseenter', () => activate(card));
      card.addEventListener('mouseleave', clear);
      card.addEventListener('touchstart', () => activate(card), { passive: true });
      card.addEventListener('touchend', () => setTimeout(clear, 700), { passive: true });
      card.addEventListener('focusin', () => activate(card));
      card.addEventListener('focusout', clear);
    });
    document.addEventListener('click', (e) => {
      if (!grid.contains(e.target)) clear();
    });
  }

  const quickModal = document.getElementById('quickModal');
  const quickSheet = quickModal ? quickModal.querySelector('.quick-sheet') : null;
  const quickImg = document.getElementById('quickImg');
  const quickHotspots = document.getElementById('quickHotspots');
  const quickTag = document.getElementById('quickTag');
  const quickName = document.getElementById('quickName');
  const quickSize = document.getElementById('quickSize');
  const quickPriceList = document.getElementById('quickPriceList');
  const quickAdd = document.getElementById('quickAdd');
  const quickDetails = document.querySelector('.quick-details');
  const quickQty = document.getElementById('quickQty');
  const quickTotal = document.getElementById('quickTotal');
  const zoomBase = 1.92;
  const liftBase = -8;

  const normalize = (text) => (text || '').toLowerCase().replace(/\\s+/g, '').replace(',', '.');
  const formatCOP = (value) => {
    const num = Number(value) || 0;
    return `$${num.toLocaleString('es-CO')}`.replace(/,/g, '.');
  };
  const getUnitPrice = (precios, qty) => {
    if (!precios || !precios.length) return 0;
    const tiers = [...precios].sort((a, b) => a.min_cantidad - b.min_cantidad);
    let chosen = tiers[0];
    tiers.forEach((tier) => {
      if (qty >= tier.min_cantidad) chosen = tier;
    });
    return Number(chosen.precio) || 0;
  };
  const updateQuickTotal = () => {
    if (!quickQty || !quickTotal) return;
    const qty = Math.max(1, parseInt(quickQty.value || '1', 10) || 1);
    quickQty.value = qty;
    const unit = activePriceTiers.length ? getUnitPrice(activePriceTiers, qty) : 0;
    if (activePriceTiers.length) renderPrices(activePriceTiers, qty);
    quickTotal.textContent = unit ? formatCOP(unit * qty) : '$0';
  };
  const renderPrices = (precios, qty = 1) => {
    quickPriceList.innerHTML = '';
    if (!precios || !precios.length) {
      const empty = document.createElement('div');
      empty.className = 'precio-card';
      empty.textContent = 'Precio disponible pronto';
      quickPriceList.appendChild(empty);
      return;
    }
    const tiers = [...precios].sort((a, b) => a.min_cantidad - b.min_cantidad);
    const chosen = tiers.reduce((acc, tier) => (qty >= tier.min_cantidad ? tier : acc), tiers[0]);
    const main = document.createElement('div');
    main.className = 'price-main';
    main.innerHTML = `<span>Valor unidad</span><strong>${formatCOP(chosen.precio)}</strong>`;
    quickPriceList.appendChild(main);
    const options = tiers.filter((tier) => tier.min_cantidad !== chosen.min_cantidad);
    if (options.length) {
      const wrap = document.createElement('div');
      wrap.className = 'price-options';
      options.forEach((tier) => {
        const chip = document.createElement('span');
        chip.className = 'price-option';
        const label = tier.min_cantidad >= 12 ? '12+' : '6+';
        chip.innerHTML = `<span class="price-label">${label}</span><strong>${formatCOP(tier.precio)}</strong>`;
        wrap.appendChild(chip);
      });
      quickPriceList.appendChild(wrap);
    }
  };

  const arielHotspots = [
    { id: '4kg', label: '4 kg', match: '4kg', img: '/static/images/ariel4.jpg', x: 6, y: 28, w: 28, hit: '6px', hitArea: '8px', scale: 1.4, scaleMobile: 1.8, lift: '-10px', liftMobile: '-12px' },
    { id: '1kg', label: '1 kg', match: '1kg', img: '/static/images/ariel1.jpg', x: 30, y: 28, w: 20, hit: '6px', hitArea: '8px', scale: 2.0, scaleMobile: 2.6 },
    { id: '450g', label: '450 g', match: '450g', img: '/static/images/ariel450.jpg', x: 54, y: 34, w: 20, hit: '8px', hitArea: '10px', scale: 2.0, scaleMobile: 2.6 },
    { id: '225g', label: '225 g', match: '225g', img: '/static/images/ariel225.jpg', x: 74, y: 38, w: 18, hit: '6px', hitArea: '8px', scale: 2.0, scaleMobile: 2.6 },
    { id: '100g', label: '100 g', match: '100g', img: '/static/images/ariel100.jpg', x: 42, y: 56, w: 18, hit: '6px', hitArea: '8px', scale: 1.9, scaleMobile: 2.2, lift: '-8px', liftMobile: '-10px' }
  ];
  const revitaHotspots = [
    { id: '2kg', label: '2 kg', match: '2kg', img: '/static/images/ariel-revita.jpg', x: 8, y: 26, w: 28, hit: '6px', hitArea: '8px', scale: 1.35, scaleMobile: 1.7, lift: '-10px', liftMobile: '-12px' },
    { id: '800g', label: '800 g', match: '800g', img: '/static/images/ariel-revita.jpg', x: 40, y: 32, w: 22, hit: '6px', hitArea: '8px', scale: 1.6, scaleMobile: 2.1 },
    { id: '450g', label: '450 g', match: '450g', img: '/static/images/ariel-revita.jpg', x: 66, y: 36, w: 20, hit: '6px', hitArea: '8px', scale: 1.6, scaleMobile: 2.1 }
  ];
  const threeDHotspots = [
    { id: '2kg', label: '2 kg', match: '2kg', img: '/static/images/3d.jpg', x: 2, y: 14, w: 36, hit: '6px', hitArea: '8px', scale: 1.4, scaleMobile: 1.8, lift: '-10px', liftMobile: '-12px' },
    { id: '1kg', label: '1 kg', match: '1kg', img: '/static/images/3d.jpg', x: 40, y: 18, w: 28, hit: '6px', hitArea: '8px', scale: 1.6, scaleMobile: 2.0 },
    { id: '500g', label: '500 g', match: '500g', img: '/static/images/3d.jpg', x: 70, y: 18, w: 24, hit: '6px', hitArea: '8px', scale: 1.6, scaleMobile: 2.0 },
    { id: '250g', label: '250 g', match: '250g', img: '/static/images/3d.jpg', x: 44, y: 62, w: 22, hit: '6px', hitArea: '8px', scale: 1.8, scaleMobile: 2.3 },
    { id: '125g', label: '125 g', match: '125g', img: '/static/images/3d.jpg', x: 72, y: 66, w: 16, hit: '6px', hitArea: '8px', scale: 1.9, scaleMobile: 2.4, lift: '-8px', liftMobile: '-10px' }
  ];
  const fabHotspots = [
    { id: '3_5kg', label: '3.5 kg', match: '3.5', img: '/static/images/fab.jpg', x: 3, y: 18, w: 30, hit: '6px', hitArea: '8px', scale: 1.35, scaleMobile: 1.7, lift: '-10px', liftMobile: '-12px' },
    { id: '2kg', label: '2 kg', match: '2kg', img: '/static/images/fab.jpg', x: 36, y: 20, w: 24, hit: '6px', hitArea: '8px', scale: 1.55, scaleMobile: 1.9 },
    { id: '800g', label: '800 g', match: '800g', img: '/static/images/fab.jpg', x: 30, y: 62, w: 28, hit: '6px', hitArea: '8px', scale: 1.8, scaleMobile: 2.3 },
    { id: '450g', label: '450 g', match: '450g', img: '/static/images/fab.jpg', x: 65, y: 46, w: 16, hit: '6px', hitArea: '8px', scale: 1.7, scaleMobile: 2.2 },
    { id: '225g', label: '225 g', match: '225g', img: '/static/images/fab.jpg', x: 60, y: 58, w: 14, hit: '6px', hitArea: '8px', scale: 1.7, scaleMobile: 2.2 },
    { id: '100g', label: '100 g', match: '100g', img: '/static/images/fab.jpg', x: 66, y: 70, w: 16, hit: '6px', hitArea: '8px', scale: 1.9, scaleMobile: 2.4, lift: '-8px', liftMobile: '-10px' }
  ];

  const buildPriceTiers = (unit) => ([
    { min_cantidad: 1, precio: unit },
    { min_cantidad: 6, precio: Math.max(1, Math.round(unit * 0.95)) },
    { min_cantidad: 12, precio: Math.max(1, Math.round(unit * 0.9)) }
  ]);
  const priceMaps = {
    ariel: {
      '4kg': 46500,
      '1kg': 12240,
      '450g': 5900,
      '225g': 3100,
      '100g': 1500
    },
    revita: {
      '2kg': 25900,
      '800g': 10600,
      '450g': 5800
    },
    '3d': {
      '2kg': 18550,
      '1kg': 9450,
      '500g': 4980,
      '250g': 2800,
      '125g': 1250
    },
    fab: {
      '3_5kg': 25990,
      '2kg': 22050,
      '800g': 14350,
      '450g': 6150,
      '225g': 2800,
      '100g': 1500
    }
  };
  const quickConfigs = {
    ariel: {
      name: 'Ariel T. Poder',
      brand: 'Ariel',
      img: '/static/images/ariel.jpg',
      hotspots: arielHotspots,
      priceMap: priceMaps.ariel
    },
    revita: {
      name: 'Ariel Revita Color',
      brand: 'Ariel',
      img: '/static/images/ariel-revita.jpg',
      hotspots: revitaHotspots,
      priceMap: priceMaps.revita
    },
    '3d': {
      name: '3D Multiusos',
      brand: '3D',
      img: '/static/images/3d.jpg',
      hotspots: threeDHotspots,
      priceMap: priceMaps['3d']
    },
    fab: {
      name: 'FAB Lavado Perfecto',
      brand: 'FAB',
      img: '/static/images/fab.jpg',
      hotspots: fabHotspots,
      priceMap: priceMaps.fab
    }
  };

  let activeVariant = null;
  let currentVariants = [];
  let activePriceTiers = [];
  let bagAutoTimer = null;
  let currentQuick = quickConfigs.ariel;
  let currentQuickType = 'ariel';
  const scheduleBagHide = () => {
    if (!quickHotspots) return;
    if (bagAutoTimer) clearTimeout(bagAutoTimer);
    bagAutoTimer = setTimeout(() => {
      quickHotspots.classList.remove('dimmed');
      quickHotspots.querySelectorAll('.bag-item').forEach((el) => el.classList.remove('active'));
    }, 900);
  };
  const selectHotspot = (hotspot, variants) => {
    if (quickHotspots) {
      quickHotspots.classList.add('dimmed');
      quickHotspots.querySelectorAll('.bag-item').forEach((el) => {
        el.classList.toggle('active', el.dataset.id === hotspot.id);
      });
    }
    const match = normalize(hotspot.match);
    activeVariant = variants.find((v) => normalize(v.contenido).includes(match)) || null;
    const quickNameBase = currentQuick ? currentQuick.name : 'Producto';
    if (quickName) quickName.textContent = `${quickNameBase} ${hotspot.label}`;
    if (quickTag) quickTag.textContent = '';
    if (quickSize) quickSize.textContent = '';
    const manualUnit = currentQuick && currentQuick.priceMap ? currentQuick.priceMap[hotspot.id] : null;
    if (!activeVariant && manualUnit) {
      activeVariant = {
        presentacion_id: `${currentQuickType}-${hotspot.id}`,
        marca: currentQuick && currentQuick.brand ? currentQuick.brand : (currentQuick ? currentQuick.name : 'Producto'),
        presentacion: currentQuick ? currentQuick.name : 'Producto',
        contenido: hotspot.label,
        imagen: currentQuick ? currentQuick.img : '/static/images/placeholder.svg'
      };
    }
    activePriceTiers = manualUnit ? buildPriceTiers(manualUnit) : (activeVariant ? (activeVariant.precios || []) : []);
    renderPrices(activePriceTiers, 1);
    if (quickAdd) {
      quickAdd.disabled = !activeVariant;
      quickAdd.textContent = 'Agregar al carrito';
    }
    if (quickDetails) quickDetails.classList.add('show');
    if (quickQty) quickQty.value = 1;
    updateQuickTotal();
    scheduleBagHide();
    const quickImageWrap = quickImg.closest('.quick-image');
    if (quickImageWrap) {
      quickImageWrap.classList.add('focused');
    }
  };

  const openQuick = (card) => {
    if (!quickModal) return;
    let variants = [];
    try {
      variants = JSON.parse(card.dataset.variantes || '[]');
    } catch (e) {
      variants = [];
    }
    currentQuickType = card.dataset.quickType || 'ariel';
    currentQuick = quickConfigs[currentQuickType] || quickConfigs.ariel;
    quickImg.dataset.fallback = '/static/images/placeholder.svg';
    quickImg.src = currentQuick.img;
    if (quickTag) quickTag.textContent = '';
    if (quickName) quickName.textContent = '';
    if (quickSize) quickSize.textContent = '';
    if (quickPriceList) quickPriceList.innerHTML = '';
    if (quickAdd) {
      quickAdd.disabled = true;
      quickAdd.textContent = 'Agregar al carrito';
    }
    if (quickDetails) quickDetails.classList.remove('show');
    activePriceTiers = [];
    if (quickQty) quickQty.value = 1;
    if (quickTotal) quickTotal.textContent = '$0';
    if (quickHotspots) {
      quickHotspots.innerHTML = '';
      quickHotspots.classList.remove('dimmed');
      currentVariants = variants;
      currentQuick.hotspots.forEach((spot) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'bag-item';
        btn.dataset.id = spot.id;
        btn.style.left = `${spot.x}%`;
        btn.style.top = `${spot.y}%`;
        btn.style.width = `${spot.w}%`;
        if (spot.hit) btn.style.setProperty('--hit', spot.hit);
        if (spot.hitArea) btn.style.setProperty('--hit-area', spot.hitArea);
        if (spot.scale) btn.style.setProperty('--scale', spot.scale);
        if (spot.scaleMobile) btn.style.setProperty('--scale-mobile', spot.scaleMobile);
        if (spot.lift) btn.style.setProperty('--lift', spot.lift);
        if (spot.liftMobile) btn.style.setProperty('--lift-mobile', spot.liftMobile);
        btn.innerHTML = `<img src="${spot.img}" alt="${spot.label}">`;
        btn.addEventListener('click', () => selectHotspot(spot, variants));
        btn.addEventListener('touchstart', (e) => {
          e.preventDefault();
          selectHotspot(spot, variants);
        }, { passive: false });
        quickHotspots.appendChild(btn);
      });
    }

    document.body.classList.add('modal-open');
    quickModal.classList.add('open');
    quickModal.setAttribute('aria-hidden', 'false');
  };

  const closeQuick = () => {
    if (!quickModal) return;
    quickModal.classList.remove('open');
    quickModal.setAttribute('aria-hidden', 'true');
    document.body.classList.remove('modal-open');
    quickImg.style.transform = '';
    const quickImageWrap = quickImg.closest('.quick-image');
    if (quickImageWrap) quickImageWrap.classList.remove('focused');
    if (quickDetails) quickDetails.classList.remove('show');
    if (quickPriceList) quickPriceList.innerHTML = '';
    if (quickAdd) {
      quickAdd.disabled = true;
      quickAdd.textContent = 'Selecciona una bolsa';
    }
    if (quickTag) quickTag.textContent = '';
    if (quickName) quickName.textContent = '';
    if (quickSize) quickSize.textContent = '';
    if (quickQty) quickQty.value = 1;
    if (quickTotal) quickTotal.textContent = '$0';
    if (bagAutoTimer) {
      clearTimeout(bagAutoTimer);
      bagAutoTimer = null;
    }
  };

  document.querySelectorAll('.tienda-card.quick-view').forEach((card) => {
    card.addEventListener('click', (e) => {
      e.preventDefault();
      openQuick(card);
    });
    card.addEventListener('touchstart', (e) => {
      e.preventDefault();
      openQuick(card);
    }, { passive: false });
  });

  if (quickModal) {
    quickModal.querySelectorAll('[data-close]').forEach((el) => {
      el.addEventListener('click', closeQuick);
    });
    quickModal.addEventListener('click', (e) => {
      if (!e.target.closest('.quick-body')) closeQuick();
    });
  }
  const quickImageWrap = quickImg ? quickImg.closest('.quick-image') : null;
  const tryPickNearest = (clientX, clientY) => {
    if (!quickImageWrap || !quickModal || !quickModal.classList.contains('open')) return;
    const rect = quickImageWrap.getBoundingClientRect();
    const x = clientX - rect.left;
    const y = clientY - rect.top;
    let best = null;
    let bestDist = Infinity;
    const spots = currentQuick ? currentQuick.hotspots : arielHotspots;
    spots.forEach((spot) => {
      const cx = rect.width * (spot.x + spot.w / 2) / 100;
      const cy = rect.height * (spot.y + spot.w / 2) / 100;
      const dist = Math.hypot(cx - x, cy - y);
      if (dist < bestDist) {
        bestDist = dist;
        best = spot;
      }
    });
    const limit = window.innerWidth <= 768 ? 320 : 230;
    if (best && bestDist <= limit) selectHotspot(best, currentVariants);
  };
  if (quickImageWrap) {
    quickImageWrap.addEventListener('click', (e) => {
      if (e.target.closest('.bag-item')) return;
      tryPickNearest(e.clientX, e.clientY);
    });
    quickImageWrap.addEventListener('touchstart', (e) => {
      if (e.target.closest('.bag-item')) return;
      const touch = e.touches && e.touches[0];
      if (!touch) return;
      tryPickNearest(touch.clientX, touch.clientY);
    }, { passive: true });
  }
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeQuick();
  });

  if (quickAdd) {
    quickAdd.addEventListener('click', () => {
      if (!activeVariant) return;
      const qty = quickQty ? Math.max(1, parseInt(quickQty.value || '1', 10) || 1) : 1;
      const unit = activePriceTiers.length ? getUnitPrice(activePriceTiers, qty) : 0;
      const item = {
        id: activeVariant.presentacion_id,
        producto: currentQuick ? currentQuick.name : 'Producto',
        marca: activeVariant.marca || 'Ariel',
        presentacion: activeVariant.presentacion,
          contenido: activeVariant.contenido,
        imagen: activeVariant.imagen,
        qty,
        unit
      };
      const stored = localStorage.getItem(CART_KEY);
      let cart = [];
      if (stored) {
        try { cart = JSON.parse(stored); } catch (e) { cart = []; }
      }
      const idx = cart.findIndex((c) => c.id === item.id);
      if (idx >= 0) {
        cart[idx].qty += item.qty;
      } else {
        cart.push(item);
      }
      localStorage.setItem(CART_KEY, JSON.stringify(cart));
      quickAdd.textContent = 'Agregado';
      updateCartCount();
      setTimeout(() => { quickAdd.textContent = 'Agregar al carrito'; }, 1400);
    });
  }

  if (quickQty) {
    quickQty.addEventListener('input', () => {
      const value = Math.max(1, parseInt(quickQty.value || '1', 10) || 1);
      quickQty.value = value;
      updateQuickTotal();
      scheduleBagHide();
    });
  }
  document.querySelectorAll('.quick-qty-control .qty-btn').forEach((btn) => {
    btn.addEventListener('click', () => {
      if (!quickQty) return;
      const delta = btn.dataset.qty === '+' ? 1 : -1;
      const value = Math.max(1, parseInt(quickQty.value || '1', 10) + delta);
      quickQty.value = value;
      updateQuickTotal();
      scheduleBagHide();
    });
  });

</script>

</body>
</html>



